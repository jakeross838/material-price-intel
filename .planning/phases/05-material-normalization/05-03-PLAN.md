---
phase: 05-material-normalization
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - material-price-intel/src/hooks/useQuoteReview.ts
  - material-price-intel/src/hooks/useMaterials.ts
  - material-price-intel/src/pages/QuoteDetailPage.tsx
autonomous: true

must_haves:
  truths:
    - "After approving a quote, normalization status is visible to the user"
    - "User can see which materials each line item was matched to"
    - "User can view canonical materials and their aliases"
  artifacts:
    - path: "material-price-intel/src/hooks/useMaterials.ts"
      provides: "React Query hooks for materials and aliases"
      contains: "useMaterials"
    - path: "material-price-intel/src/hooks/useQuoteReview.ts"
      provides: "Updated approve hook that invalidates material queries"
      contains: "materials"
    - path: "material-price-intel/src/pages/QuoteDetailPage.tsx"
      provides: "Material linkage display on line items"
      contains: "material_id"
  key_links:
    - from: "useMaterials.ts"
      to: "supabase"
      via: "React Query + Supabase client"
      pattern: "supabase.*from.*materials"
    - from: "QuoteDetailPage.tsx"
      to: "useMaterials.ts"
      via: "import hook"
      pattern: "import.*useMaterials"
---

<objective>
Create React Query hooks for querying materials and aliases. Update the QuoteDetailPage to show material linkage on line items after normalization. Update the approve hook to invalidate material caches so normalization results appear.

Purpose: Users need to see that normalization worked -- which canonical material each line item was matched to. This is the feedback loop that builds trust in the AI normalization.

Output: Hooks for material data, updated quote detail page showing material links.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-material-normalization/05-01-SUMMARY.md
@.planning/phases/05-material-normalization/05-02-SUMMARY.md
@material-price-intel/src/hooks/useQuoteReview.ts
@material-price-intel/src/pages/QuoteDetailPage.tsx
@material-price-intel/src/lib/types.ts
@material-price-intel/src/lib/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useMaterials hooks</name>
  <files>material-price-intel/src/hooks/useMaterials.ts</files>
  <action>
Create a hooks file for material-related data queries. Follow the patterns in `useQuoteReview.ts` and `useDocumentStatus.ts` (React Query + Supabase).

**1. useMaterials hook** -- fetches all active materials for the current org:
```typescript
export function useMaterials() {
  return useQuery({
    queryKey: ["materials"],
    queryFn: async () => {
      const { data, error } = await supabase
        .from("materials")
        .select("*, material_aliases(*)")
        .eq("is_active", true)
        .order("canonical_name");
      if (error) throw error;
      return data;
    },
    staleTime: 5 * 60 * 1000, // 5 minutes, matching project convention
  });
}
```

**2. useMaterialAliases hook** -- fetches aliases for a specific material:
```typescript
export function useMaterialAliases(materialId: string | null) {
  return useQuery({
    queryKey: ["material_aliases", materialId],
    queryFn: async () => {
      if (!materialId) return [];
      const { data, error } = await supabase
        .from("material_aliases")
        .select("*")
        .eq("material_id", materialId)
        .order("created_at", { ascending: false });
      if (error) throw error;
      return data;
    },
    enabled: !!materialId,
    staleTime: 5 * 60 * 1000,
  });
}
```

**3. useMergeMaterials mutation:**
```typescript
export function useMergeMaterials() {
  const queryClient = useQueryClient();
  return useMutation<void, Error, { keepId: string; mergeId: string }>({
    mutationFn: async ({ keepId, mergeId }) => {
      const { error } = await supabase.rpc("merge_materials", {
        p_keep_id: keepId,
        p_merge_id: mergeId,
      });
      if (error) throw new Error("Failed to merge materials: " + error.message);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["materials"] });
      queryClient.invalidateQueries({ queryKey: ["material_aliases"] });
    },
  });
}
```

**4. useLineItemMaterials hook** -- fetches line items with their linked material for a quote:
```typescript
export function useLineItemMaterials(quoteId: string) {
  return useQuery({
    queryKey: ["line_items_with_materials", quoteId],
    queryFn: async () => {
      const { data, error } = await supabase
        .from("line_items")
        .select("id, raw_description, material_id, materials(id, canonical_name, species, dimensions)")
        .eq("quote_id", quoteId)
        .order("sort_order");
      if (error) throw error;
      return data;
    },
    staleTime: 5 * 60 * 1000,
  });
}
```

Import from `@tanstack/react-query` (useQuery, useMutation, useQueryClient) and `@/lib/supabase`.
  </action>
  <verify>Run `cd material-price-intel && npx tsc --noEmit` to verify no type errors.</verify>
  <done>Four hooks created: useMaterials (all active materials with aliases), useMaterialAliases (aliases for one material), useMergeMaterials (merge mutation), useLineItemMaterials (line items with joined material data). All use React Query with 5-minute staleTime.</done>
</task>

<task type="auto">
  <name>Task 2: Update QuoteDetailPage to show material linkage</name>
  <files>
    material-price-intel/src/pages/QuoteDetailPage.tsx
    material-price-intel/src/hooks/useQuoteReview.ts
  </files>
  <action>
**In useQuoteReview.ts:**
Update `useApproveQuote` onSuccess to also invalidate material-related queries so normalization results appear after the trigger fires:
```typescript
onSuccess: (_data, quoteId) => {
  queryClient.invalidateQueries({ queryKey: ["quote", quoteId] });
  queryClient.invalidateQueries({ queryKey: ["documents", "recent"] });
  queryClient.invalidateQueries({ queryKey: ["materials"] });
  queryClient.invalidateQueries({ queryKey: ["line_items_with_materials", quoteId] });
},
```

Note: The normalization runs asynchronously (pg_net trigger), so the initial invalidation may show un-normalized items. Add a delayed re-invalidation after 10 seconds to catch normalization completion:
```typescript
onSuccess: (_data, quoteId) => {
  queryClient.invalidateQueries({ queryKey: ["quote", quoteId] });
  queryClient.invalidateQueries({ queryKey: ["documents", "recent"] });
  // Normalization runs async via Edge Function; re-fetch after delay
  setTimeout(() => {
    queryClient.invalidateQueries({ queryKey: ["materials"] });
    queryClient.invalidateQueries({ queryKey: ["line_items_with_materials"] });
  }, 10_000);
},
```

**In QuoteDetailPage.tsx:**
1. Import `useLineItemMaterials` from `@/hooks/useMaterials`.

2. Call it: `const { data: lineItemMaterials } = useLineItemMaterials(quoteId)` (where quoteId is already available from the page).

3. In the line items table/list, for each line item that has `material_id` set, show a small badge or link with the canonical material name. If `material_id` is null, show nothing (normalization pending or not yet approved).

The specific UI change is a small addition -- after each line item's `raw_description`, show:
```tsx
{lineItemMaterial?.materials?.canonical_name && (
  <span className="ml-2 inline-flex items-center rounded-full bg-blue-50 px-2 py-0.5 text-xs text-blue-700">
    {lineItemMaterial.materials.canonical_name}
  </span>
)}
```

Find the line items rendering section (the map over line items) and add this badge. Read the QuoteDetailPage.tsx first to find the exact location.

Do NOT restructure the page. This is a surgical addition of a material name badge on each line item row.
  </action>
  <verify>
1. `cd material-price-intel && npx tsc --noEmit` -- no type errors.
2. `cd material-price-intel && npm run build` -- builds successfully.
3. Visually: After approving a quote, line items should show a blue badge with the canonical material name after normalization completes (~10 seconds).
  </verify>
  <done>
QuoteDetailPage shows canonical material name badge on each normalized line item. Approve hook triggers delayed cache invalidation so normalization results appear automatically. useLineItemMaterials hook provides joined material data.
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors
- App builds successfully
- useMaterials, useMaterialAliases, useMergeMaterials, useLineItemMaterials hooks all created
- QuoteDetailPage shows material badge on normalized line items
- Approve action triggers cache invalidation for material data
</verification>

<success_criteria>
After a quote is approved and normalization completes, the user sees canonical material names appear as badges on each line item in the quote detail view. Material hooks are available for future use by the materials management page and search features.
</success_criteria>

<output>
After completion, create `.planning/phases/05-material-normalization/05-03-SUMMARY.md`
</output>
