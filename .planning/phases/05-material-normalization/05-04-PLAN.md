---
phase: 05-material-normalization
plan: 04
type: execute
wave: 4
depends_on: ["05-01", "05-03"]
files_modified:
  - material-price-intel/src/pages/MaterialsPage.tsx
  - material-price-intel/src/App.tsx
  - material-price-intel/src/components/layout/AppLayout.tsx
autonomous: false

must_haves:
  truths:
    - "User can see a list of all canonical materials with alias counts"
    - "User can view all aliases for a given material"
    - "User can merge two materials into one"
    - "User can manually reassign a line item to a different material"
    - "User can create a new material from the Materials page"
  artifacts:
    - path: "material-price-intel/src/pages/MaterialsPage.tsx"
      provides: "Materials management page with merge, reassign, and create-new capability"
      min_lines: 100
      contains: "MaterialsPage"
    - path: "material-price-intel/src/App.tsx"
      provides: "Route to materials page"
      contains: "/materials"
    - path: "material-price-intel/src/components/layout/AppLayout.tsx"
      provides: "Navigation link to materials page"
      contains: "/materials"
  key_links:
    - from: "MaterialsPage.tsx"
      to: "useMaterials"
      via: "import hook"
      pattern: "import.*useMaterials"
    - from: "MaterialsPage.tsx"
      to: "useMergeMaterials"
      via: "import hook"
      pattern: "import.*useMergeMaterials"
    - from: "App.tsx"
      to: "MaterialsPage.tsx"
      via: "React Router route"
      pattern: "MaterialsPage"
    - from: "AppLayout.tsx"
      to: "/materials"
      via: "navItems array entry"
      pattern: "materials"
---

<objective>
Create a Materials management page where the user can see all canonical materials, their aliases, merge materials, reassign line items between materials, and create new materials. Add the route and navigation link.

Purpose: AI normalization won't be perfect 100% of the time. The user needs a way to correct it -- merging two materials that should be one, creating a new material when the AI missed one, and reassigning line items when they were linked to the wrong material. Together, merge + create-new + reassign covers all correction scenarios (including the "split" use case from ROADMAP SC-7: to split a material, create the new material, then reassign the relevant line items to it).

Output: Materials page with list, alias drill-down, merge, reassign, and create-new functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-material-normalization/05-01-SUMMARY.md
@.planning/phases/05-material-normalization/05-03-SUMMARY.md
@material-price-intel/src/App.tsx
@material-price-intel/src/components/layout/AppLayout.tsx
@material-price-intel/src/pages/DashboardPage.tsx
@material-price-intel/src/hooks/useMaterials.ts
@material-price-intel/src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MaterialsPage with list, aliases, merge, reassign, and create-new</name>
  <files>material-price-intel/src/pages/MaterialsPage.tsx</files>
  <action>
Create `MaterialsPage.tsx` following the styling and layout patterns of `DashboardPage.tsx` and `QuoteDetailPage.tsx` (read them first to match the design system -- likely Tailwind + shadcn components).

**Page layout:**

1. **Header:** "Materials" title with a count badge showing total active materials, and a "Create New Material" button (see section 6 below).

2. **Materials table/list:**
   - Columns: Canonical Name, Species, Dimensions, Grade, Treatment, Category, Aliases (count), Actions
   - Sort by canonical_name alphabetically
   - Each row shows the material's structured fields
   - Aliases count is a clickable badge that expands to show all aliases and linked line items inline

3. **Alias expansion with line item reassignment:**
   When the user clicks the alias count badge on a material row, expand an inline section below the row showing:
   - **Aliases sub-section:** Each alias text, source quote link (if source_quote_id exists), date added
   - **Linked Line Items sub-section:** Query line_items where material_id matches this material. Show each line item's raw_description, quote supplier name, and a "Reassign to..." dropdown.
   - The "Reassign to..." dropdown lists all other active materials (from useMaterials hook data). When the user selects a different material, update the line_item's material_id via Supabase:
     ```typescript
     await supabase.from("line_items").update({ material_id: newMaterialId }).eq("id", lineItemId);
     ```
   - After reassignment, invalidate the relevant queries (materials, line_items_with_materials).
   - This covers ROADMAP SC-7 "split" -- to split a material, the user creates the target material first (see section 6), then reassigns the relevant line items to it.

4. **Merge functionality:**
   - Add a "Merge" button that enters merge mode
   - In merge mode, user selects two materials (checkboxes)
   - When two are selected, show a "Merge Selected" button
   - Clicking "Merge Selected" shows a confirmation: "Keep [Material A] and merge [Material B] into it? All line items and aliases from B will be moved to A."
   - First selected material is the "keep" material, second is "merge" material
   - Uses `useMergeMaterials` hook from `useMaterials.ts`
   - After merge, refresh the list

5. **Empty state:**
   If no materials exist yet, show: "No materials normalized yet. Approve a quote to start building your material catalog."

6. **Create New Material:**
   - A "Create New Material" button in the page header opens a modal/dialog
   - The dialog has fields: Canonical Name (required), Species, Dimensions, Grade, Treatment, Category (dropdown of material_categories), Unit of Measure
   - On submit, insert into materials table via Supabase:
     ```typescript
     await supabase.from("materials").insert({
       organization_id: orgId,
       category_id: selectedCategoryId,
       canonical_name: name,
       species, dimensions, grade, treatment, unit_of_measure,
     });
     ```
   - After creation, invalidate materials query and close dialog
   - This enables the "split" workflow: create new material -> reassign line items to it

**Use these hooks (already created in Plan 03):**
- `useMaterials()` for the main list
- `useMaterialAliases(selectedMaterialId)` for alias drill-down
- `useMergeMaterials()` for the merge mutation

**Styling:**
- Follow existing page patterns (container, heading, table/card layout)
- Use shadcn UI components if the project uses them (check existing pages)
- Tailwind utility classes matching the project's existing patterns
- Blue badge for alias counts (matching the line item material badge from Plan 03)
  </action>
  <verify>
1. `cd material-price-intel && npx tsc --noEmit` -- no type errors.
2. `cd material-price-intel && npm run build` -- builds successfully.
  </verify>
  <done>
MaterialsPage created with: materials list showing all canonical materials with structured fields, expandable alias sections with linked line items, line item reassignment dropdown per line item, merge mode with two-material selection and confirmation, "Create New Material" dialog for manual material creation, empty state messaging.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add materials route to App.tsx and navigation link to AppLayout.tsx</name>
  <files>
    material-price-intel/src/App.tsx
    material-price-intel/src/components/layout/AppLayout.tsx
  </files>
  <action>
**In App.tsx:**
1. Import MaterialsPage: `import { MaterialsPage } from "@/pages/MaterialsPage"` (or default import, matching existing pattern).
2. Add a route for `/materials` inside the authenticated AppLayout routes, after the quote detail route and before the catch-all comment:
```tsx
<Route path="/materials" element={<MaterialsPage />} />
```

**In AppLayout.tsx:**
1. Import the `Layers` icon from lucide-react (add to existing import): `import { LayoutDashboard, Upload, FileText, Search, Layers, LogOut } from "lucide-react";`
2. Add a "Materials" entry to the `navItems` array:
```typescript
const navItems = [
  { to: "/", label: "Dashboard", icon: LayoutDashboard },
  { to: "/upload", label: "Upload", icon: Upload },
  { to: "/quotes", label: "Quotes", icon: FileText },
  { to: "/materials", label: "Materials", icon: Layers },
  { to: "/search", label: "Search", icon: Search },
];
```
Place it after Quotes and before Search -- logical grouping since materials are derived from quotes and feed into search.
  </action>
  <verify>
1. `cd material-price-intel && npm run build` -- builds successfully.
2. Navigate to `/materials` in the browser -- page renders without errors.
3. Sidebar navigation shows "Materials" link with Layers icon between Quotes and Search.
  </verify>
  <done>
Materials page accessible at /materials route. Navigation sidebar has "Materials" link with Layers icon. Route follows existing auth-guard and AppLayout patterns.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Materials management page with canonical material list, alias drill-down with linked line items, line item reassignment, merge functionality, and "Create New Material" button. Material badges on line items in quote detail. Full normalization pipeline: approve quote -> AI classification -> fuzzy match -> create/link material -> show results. Full correction toolkit: merge, create new, reassign.
  </what-built>
  <how-to-verify>
1. Navigate to the app in browser
2. If you have an existing approved quote, go to its detail page and check if line items show material badges (blue badges with canonical names)
3. Navigate to `/materials` via the sidebar link and verify the materials list shows canonical materials with their structured fields
4. Click an alias count badge to expand and see description variations AND linked line items
5. Test line item reassignment: in the expanded view, use the "Reassign to..." dropdown on a line item to move it to a different material
6. Test "Create New Material": click the button in the header, fill in the form, submit, verify the new material appears in the list
7. Test the merge flow:
   a. Click "Merge" to enter merge mode
   b. Select two materials
   c. Click "Merge Selected" and confirm
   d. Verify the merged material disappears and its aliases transfer
8. If no approved quotes exist yet, upload a PDF, let it extract, review it, approve it, wait ~15 seconds, then check `/materials` for normalized results
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- /materials route loads without errors
- Sidebar shows "Materials" navigation link with Layers icon
- Materials list shows canonical materials from database
- Alias expansion shows all description variations and linked line items
- Line item reassignment dropdown works (moves line item to different material)
- "Create New Material" dialog creates a new material entry
- Merge flow works: select two, confirm, aliases transfer, merged material deactivated
- Empty state shown when no materials exist
- Full pipeline tested: approve -> normalize -> display
- Split workflow works: create new material -> reassign line items to it
</verification>

<success_criteria>
User can view all canonical materials at /materials, see their aliases and linked line items, merge incorrectly separated materials, create new materials, and reassign line items between materials. The complete normalization pipeline is visible end-to-end. The correction toolkit (merge + create-new + reassign) covers all cases including "split" (ROADMAP SC-7).
</success_criteria>

<output>
After completion, create `.planning/phases/05-material-normalization/05-04-SUMMARY.md`
</output>
