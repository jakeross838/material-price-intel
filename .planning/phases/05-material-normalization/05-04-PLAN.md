---
phase: 05-material-normalization
plan: 04
type: execute
wave: 3
depends_on: ["05-01", "05-03"]
files_modified:
  - material-price-intel/src/pages/MaterialsPage.tsx
  - material-price-intel/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User can see a list of all canonical materials with alias counts"
    - "User can view all aliases for a given material"
    - "User can merge two materials into one"
    - "User can manually reassign a line item to a different material"
  artifacts:
    - path: "material-price-intel/src/pages/MaterialsPage.tsx"
      provides: "Materials management page with merge capability"
      min_lines: 100
      contains: "MaterialsPage"
    - path: "material-price-intel/src/App.tsx"
      provides: "Route to materials page"
      contains: "/materials"
  key_links:
    - from: "MaterialsPage.tsx"
      to: "useMaterials"
      via: "import hook"
      pattern: "import.*useMaterials"
    - from: "MaterialsPage.tsx"
      to: "useMergeMaterials"
      via: "import hook"
      pattern: "import.*useMergeMaterials"
    - from: "App.tsx"
      to: "MaterialsPage.tsx"
      via: "React Router route"
      pattern: "MaterialsPage"
---

<objective>
Create a Materials management page where the user can see all canonical materials, their aliases, and merge materials that the AI incorrectly separated. Add the route to the app router.

Purpose: AI normalization won't be perfect 100% of the time. The user needs a way to correct it -- merging two materials that should be one, or seeing what aliases exist. This is requirement MAT-01's "user can manually merge or split canonical materials."

Output: Materials page with list, alias drill-down, and merge functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-material-normalization/05-01-SUMMARY.md
@.planning/phases/05-material-normalization/05-03-SUMMARY.md
@material-price-intel/src/App.tsx
@material-price-intel/src/pages/DashboardPage.tsx
@material-price-intel/src/hooks/useMaterials.ts
@material-price-intel/src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MaterialsPage with list, aliases, and merge</name>
  <files>material-price-intel/src/pages/MaterialsPage.tsx</files>
  <action>
Create `MaterialsPage.tsx` following the styling and layout patterns of `DashboardPage.tsx` and `QuoteDetailPage.tsx` (read them first to match the design system -- likely Tailwind + shadcn components).

**Page layout:**

1. **Header:** "Materials" title with a count badge showing total active materials.

2. **Materials table/list:**
   - Columns: Canonical Name, Species, Dimensions, Grade, Treatment, Category, Aliases (count), Actions
   - Sort by canonical_name alphabetically
   - Each row shows the material's structured fields
   - Aliases count is a clickable badge that expands to show all aliases inline

3. **Alias expansion:**
   When the user clicks the alias count badge on a material row, expand an inline section below the row showing:
   - Each alias text
   - Source quote link (if source_quote_id exists)
   - Date added

4. **Merge functionality:**
   - Add a "Merge" button that enters merge mode
   - In merge mode, user selects two materials (checkboxes)
   - When two are selected, show a "Merge Selected" button
   - Clicking "Merge Selected" shows a confirmation: "Keep [Material A] and merge [Material B] into it? All line items and aliases from B will be moved to A."
   - First selected material is the "keep" material, second is "merge" material
   - Uses `useMergeMaterials` hook from `useMaterials.ts`
   - After merge, refresh the list

5. **Empty state:**
   If no materials exist yet, show: "No materials normalized yet. Approve a quote to start building your material catalog."

**Use these hooks (already created in Plan 03):**
- `useMaterials()` for the main list
- `useMaterialAliases(selectedMaterialId)` for alias drill-down
- `useMergeMaterials()` for the merge mutation

**Styling:**
- Follow existing page patterns (container, heading, table/card layout)
- Use shadcn UI components if the project uses them (check existing pages)
- Tailwind utility classes matching the project's existing patterns
- Blue badge for alias counts (matching the line item material badge from Plan 03)
  </action>
  <verify>
1. `cd material-price-intel && npx tsc --noEmit` -- no type errors.
2. `cd material-price-intel && npm run build` -- builds successfully.
  </verify>
  <done>
MaterialsPage created with: materials list showing all canonical materials with structured fields, expandable alias sections, merge mode with two-material selection and confirmation, empty state messaging.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add materials route to App.tsx</name>
  <files>material-price-intel/src/App.tsx</files>
  <action>
1. Read `App.tsx` to understand the routing pattern (React Router, layout component, auth guards).

2. Import MaterialsPage: `import { MaterialsPage } from "@/pages/MaterialsPage"` (or default import, matching existing pattern).

3. Add a route for `/materials` following the same pattern as existing routes (likely inside the authenticated layout). Place it after the quote detail route and before the catch-all.

4. If there is a navigation/sidebar component, add a "Materials" link. If navigation is in App.tsx or a layout component, add it there. If navigation is in a separate component, note the file that needs the nav link but do NOT modify it if it wasn't listed in files_modified -- instead, add the nav link in the layout/nav component if it's in App.tsx.
  </action>
  <verify>
1. `cd material-price-intel && npm run build` -- builds successfully.
2. Navigate to `/materials` in the browser -- page renders without errors.
  </verify>
  <done>
Materials page accessible at /materials route. Navigation link added if applicable. Route follows existing auth-guard and layout patterns.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Materials management page with canonical material list, alias drill-down, and merge functionality. Material badges on line items in quote detail. Full normalization pipeline: approve quote -> AI classification -> fuzzy match -> create/link material -> show results.
  </what-built>
  <how-to-verify>
1. Navigate to the app in browser
2. If you have an existing approved quote, go to its detail page and check if line items show material badges (blue badges with canonical names)
3. Navigate to `/materials` and verify the materials list shows canonical materials with their structured fields
4. Click an alias count badge to expand and see description variations
5. If multiple materials exist, test the merge flow:
   a. Click "Merge" to enter merge mode
   b. Select two materials
   c. Click "Merge Selected" and confirm
   d. Verify the merged material disappears and its aliases transfer
6. If no approved quotes exist yet, upload a PDF, let it extract, review it, approve it, wait ~15 seconds, then check `/materials` for normalized results
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- /materials route loads without errors
- Materials list shows canonical materials from database
- Alias expansion shows all description variations
- Merge flow works: select two, confirm, aliases transfer, merged material deactivated
- Empty state shown when no materials exist
- Full pipeline tested: approve -> normalize -> display
</verification>

<success_criteria>
User can view all canonical materials at /materials, see their aliases, and merge incorrectly separated materials. The complete normalization pipeline is visible end-to-end: approve a quote, normalization runs automatically, material badges appear on line items, materials page shows the catalog.
</success_criteria>

<output>
After completion, create `.planning/phases/05-material-normalization/05-04-SUMMARY.md`
</output>
