---
phase: 04-review-ui
plan: 03
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - material-price-intel/src/pages/QuoteDetailPage.tsx
  - material-price-intel/src/pages/DashboardPage.tsx
  - material-price-intel/src/components/documents/RecentUploads.tsx
autonomous: false

must_haves:
  truths:
    - "QuoteDetailPage shows PDF on left and review form on right for unverified quotes"
    - "QuoteDetailPage shows read-only view for already-approved quotes"
    - "User can edit fields, save changes, and approve a quote from the review page"
    - "Validation warnings are visible on the review page"
    - "Dashboard shows document counts by status"
    - "RecentUploads shows 'approved' status badge correctly"
  artifacts:
    - path: "material-price-intel/src/pages/QuoteDetailPage.tsx"
      provides: "Side-by-side PDF + review form for unverified quotes, read-only for approved"
      min_lines: 120
    - path: "material-price-intel/src/pages/DashboardPage.tsx"
      provides: "Dashboard with document status counts"
      min_lines: 40
    - path: "material-price-intel/src/components/documents/RecentUploads.tsx"
      provides: "Updated status config including approved status badge"
  key_links:
    - from: "QuoteDetailPage"
      to: "ReviewForm + LineItemsEditor"
      via: "import and render"
      pattern: "import.*ReviewForm|import.*LineItemsEditor"
    - from: "QuoteDetailPage"
      to: "useApproveQuote + useUpdateQuoteReview"
      via: "hook calls"
      pattern: "useApproveQuote|useUpdateQuoteReview"
    - from: "QuoteDetailPage"
      to: "PDF iframe/embed"
      via: "signed URL in iframe"
      pattern: "iframe|embed|object.*pdf"
    - from: "DashboardPage"
      to: "supabase.from('documents')"
      via: "status count query"
      pattern: "documents.*count|status.*count"
---

<objective>
Integrate review components into QuoteDetailPage with side-by-side PDF view, enhance Dashboard with status overview, and verify the full review workflow end-to-end.

Purpose: This is the final assembly plan — it takes the components from Plan 02 and wires them into the existing pages. The QuoteDetailPage becomes the central review hub where users see the original PDF alongside extracted data, make corrections, and approve quotes. The Dashboard gets a status overview so users can see what needs attention.

Output: Extended QuoteDetailPage with review mode, enhanced DashboardPage with status counts, and a human verification checkpoint.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Reference Plan 02 SUMMARY for component APIs:
@.planning/phases/04-review-ui/04-02-SUMMARY.md

Key files:
@material-price-intel/src/pages/QuoteDetailPage.tsx
@material-price-intel/src/pages/DashboardPage.tsx
@material-price-intel/src/components/documents/RecentUploads.tsx
@material-price-intel/src/App.tsx
@material-price-intel/src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend QuoteDetailPage with side-by-side PDF + review form</name>
  <files>material-price-intel/src/pages/QuoteDetailPage.tsx</files>
  <action>
Extend the EXISTING QuoteDetailPage.tsx (do NOT rewrite from scratch). The page currently shows a read-only view of quote details. Add a review/edit mode that activates when the quote is not yet approved.

**Layout changes:**
- When `quote.is_verified === false` (review mode): Show a two-column side-by-side layout:
  - **Left column (50% width):** Embedded PDF viewer using an `<iframe>` with the signed URL. The iframe should have `width: 100%`, `height: 100%`, and be inside a sticky container so it stays visible while scrolling the form. Use CSS `position: sticky; top: 1rem;` on the PDF container.
  - **Right column (50% width):** The ReviewForm component with all editable fields and the LineItemsEditor below it. Also show ValidationWarnings at the top of this column.

- When `quote.is_verified === true` (approved/read-only mode): Keep the EXISTING read-only layout. Add a green "Approved" badge in the header area.

**Implementation details:**

1. **Import new components:**
   ```typescript
   import { ReviewForm } from "@/components/review/ReviewForm";
   import { LineItemsEditor, type EditableLineItem } from "@/components/review/LineItemsEditor";
   import { ValidationWarnings } from "@/components/review/ValidationWarnings";
   import { ConfidenceBadge } from "@/components/review/ConfidenceBadge";
   import { useApproveQuote, useUpdateQuoteReview } from "@/hooks/useQuoteReview";
   ```

2. **Add state for editable line items:**
   ```typescript
   const [editableLineItems, setEditableLineItems] = useState<EditableLineItem[]>([]);
   ```
   Initialize from the fetched `lineItems` data when it loads (useEffect). Map each LineItem to an EditableLineItem by adding the item's `id` as the key and pulling confidence from `quote.raw_extraction.extraction.line_items[index].confidence` if available.

3. **Hook up review hooks:**
   ```typescript
   const approveQuote = useApproveQuote();
   const updateQuoteReview = useUpdateQuoteReview();
   ```

4. **Handle save:**
   Create a `handleSave` function that gathers current form state and calls `updateQuoteReview.mutateAsync(...)` with all current field values and the editableLineItems array.

5. **Handle approve:**
   Create a `handleApprove` function that calls `approveQuote.mutateAsync(quote.id)`. After success, show the read-only view (the query will refetch and is_verified will be true).

6. **Parse validation warnings:**
   Extract warnings from `quote.raw_extraction`:
   ```typescript
   const rawExtraction = quote.raw_extraction as any;
   const validationWarnings = rawExtraction?.validation_warnings ?? [];
   ```

7. **Replace the existing `confidenceBadge` inline function** with the imported ConfidenceBadge component.

8. **Conditional rendering:**
   ```
   if (quote.is_verified) {
     // Existing read-only layout (keep as-is, add "Approved" badge)
   } else {
     // New side-by-side review layout
   }
   ```

**Side-by-side layout structure (review mode):**
```tsx
<div className="flex gap-6" style={{ minHeight: "calc(100vh - 12rem)" }}>
  {/* PDF Viewer */}
  <div className="w-1/2 shrink-0">
    <div className="sticky top-4">
      {docUrl ? (
        <iframe
          src={docUrl}
          className="w-full rounded-lg border"
          style={{ height: "calc(100vh - 10rem)" }}
          title="Original Quote PDF"
        />
      ) : (
        <div className="flex items-center justify-center h-64 rounded-lg border bg-muted">
          <p className="text-muted-foreground">PDF not available</p>
        </div>
      )}
    </div>
  </div>

  {/* Review Form */}
  <div className="w-1/2 space-y-4">
    <ValidationWarnings warnings={validationWarnings} />
    <ReviewForm
      quote={quote}
      lineItems={editableLineItems}
      onLineItemsChange={setEditableLineItems}
      onSave={handleSave}
      onApprove={handleApprove}
      isSaving={updateQuoteReview.isPending}
      isApproving={approveQuote.isPending}
    />
    <LineItemsEditor
      items={editableLineItems}
      onChange={setEditableLineItems}
    />
  </div>
</div>
```

**Header updates for review mode:**
- Show "Review Quote {number}" instead of just "Quote {number}"
- Show ConfidenceBadge prominently
- Keep the "View PDF" button for approved quotes, remove it for review mode (PDF is inline)
- Add "Back to uploads" link

**IMPORTANT:** Keep ALL existing read-only rendering code. Wrap it in the `quote.is_verified` conditional. Do not delete any existing functionality.
  </action>
  <verify>
    1. QuoteDetailPage imports ReviewForm, LineItemsEditor, ValidationWarnings, ConfidenceBadge
    2. QuoteDetailPage imports useApproveQuote, useUpdateQuoteReview
    3. Side-by-side layout renders when `is_verified === false`
    4. PDF iframe uses the signed URL
    5. Read-only layout preserved when `is_verified === true`
    6. handleSave calls updateQuoteReview mutation
    7. handleApprove calls approveQuote mutation
    8. `npm run build` passes
  </verify>
  <done>
    QuoteDetailPage shows side-by-side PDF + review form for unverified quotes. Approved quotes show the original read-only view with a green "Approved" badge. Save and Approve actions are wired to the review hooks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance Dashboard with status overview + update RecentUploads for approved status</name>
  <files>
    material-price-intel/src/pages/DashboardPage.tsx
    material-price-intel/src/components/documents/RecentUploads.tsx
  </files>
  <action>
**DashboardPage.tsx — Add document status overview:**

Replace the current placeholder dashboard with a useful status overview. Keep the welcome message and "Upload Quote" button, but add a status card grid below:

1. Add a React Query hook to fetch document counts by status:
```typescript
const { data: statusCounts } = useQuery({
  queryKey: ["documents", "status-counts"],
  queryFn: async () => {
    const statuses = ["pending", "processing", "completed", "review_needed", "approved", "failed"] as const;
    const counts: Record<string, number> = {};

    for (const status of statuses) {
      const { count, error } = await supabase
        .from("documents")
        .select("*", { count: "exact", head: true })
        .eq("status", status);

      if (!error) {
        counts[status] = count ?? 0;
      }
    }
    return counts;
  },
});
```

2. Render a grid of status cards (3 cols on desktop, 2 on tablet, 1 on mobile):
```
| Pending      | Processing   | Needs Review |
| Completed    | Approved     | Failed       |
```

Each card shows:
- Status name with colored icon (matching RecentUploads colors)
- Count number (large, bold)
- The "Needs Review" card should be more prominent if count > 0 (amber border)

3. Below the status cards, add a "Needs Attention" section:
- Query documents with status `review_needed` (limit 5)
- Show them in a list similar to RecentUploads but with "Review" button that navigates to `/quotes/{quote_id}`
- If none need review, show "All caught up! No documents need review."

4. Keep the existing "Upload Quote" button. Make it use `Link` from react-router to navigate to `/upload` instead of being a dead button.

5. Import required dependencies: `useQuery` from react-query, `supabase`, `Link` from react-router, lucide icons (FileText, AlertTriangle, CheckCircle, Clock, Loader2, Upload)

**RecentUploads.tsx — Add approved status badge:**

Update the `statusConfig` record to include the `approved` status:

```typescript
approved: {
  label: "Approved",
  className: "bg-emerald-100 text-emerald-800",
},
```

Use `bg-emerald-100 text-emerald-800` (slightly different from completed's green) to visually distinguish approved from completed.

The rest of the RecentUploads component works correctly — the `hasQuote` check already includes `completed` and `review_needed`. Add `approved` to the navigable statuses:

```typescript
const hasQuote = doc.quote_id && (doc.status === "completed" || doc.status === "review_needed" || doc.status === "approved");
```
  </action>
  <verify>
    1. DashboardPage shows status count cards for all document statuses
    2. DashboardPage shows "Needs Attention" section with review_needed documents
    3. "Upload Quote" button navigates to /upload
    4. RecentUploads statusConfig includes "approved" with emerald styling
    5. RecentUploads navigates to quote detail for approved documents
    6. `npm run build` passes
  </verify>
  <done>
    Dashboard shows document status overview with counts and a "Needs Attention" section highlighting documents needing review. RecentUploads supports the approved status with emerald badge styling and navigation.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 4 human review workflow:
    1. Database migrations for approved status and review RPCs (Plan 01)
    2. Review form components with editable fields, confidence highlighting, validation warnings (Plan 02)
    3. QuoteDetailPage with side-by-side PDF + review form (this plan)
    4. Dashboard with document status overview (this plan)

    The full flow: Upload PDF -> auto-extraction -> document appears with status -> click to review -> see PDF + extracted data side-by-side -> edit any field -> approve -> status changes to approved.
  </what-built>
  <how-to-verify>
    **Pre-requisites:**
    1. Apply migrations 007 and 008 to Supabase (via SQL editor or `supabase db push`)
    2. Configure the Database Webhook in Supabase Dashboard per migration 007 instructions
    3. Run `npm run dev` in `material-price-intel/`

    **Test the review flow:**
    1. Navigate to the Dashboard at http://localhost:5173/
    2. Verify the status overview cards show correct counts
    3. Click "Upload Quote" — should navigate to /upload
    4. Upload a PDF quote document
    5. Watch the RecentUploads list — document should go from pending -> processing -> completed/review_needed
       (Note: If the Database Webhook is not yet configured, the document will stay "pending". In that case, manually trigger extraction via curl)
    6. Click on a completed/review_needed document to go to the quote detail page
    7. Verify side-by-side layout: PDF on left, review form on right
    8. Verify low-confidence fields are highlighted in yellow/orange
    9. Verify validation warnings are shown (if any)
    10. Edit a field (e.g., change a line item quantity)
    11. Click "Save Changes" — verify the edit persists (refresh the page)
    12. Click "Approve Quote" — verify status changes to approved
    13. After approval, verify the page switches to read-only view with green "Approved" badge
    14. Go back to Dashboard — verify the "Approved" count increased

    **Check approved state:**
    15. Navigate to an approved quote — should show read-only view (not editable)
    16. Check RecentUploads — approved document should show emerald "Approved" badge
  </how-to-verify>
  <resume-signal>Type "approved" if the review workflow works correctly, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. QuoteDetailPage shows side-by-side PDF + review form for unverified quotes
2. QuoteDetailPage shows read-only view for approved quotes
3. Save and Approve buttons work correctly
4. Validation warnings are displayed
5. Low-confidence fields are highlighted
6. Dashboard shows document status counts
7. Dashboard shows "Needs Attention" section
8. RecentUploads shows approved status badge
9. Full end-to-end flow works: upload -> extract -> review -> approve
10. `npm run build` passes
</verification>

<success_criteria>
- Side-by-side view: PDF on left, extracted data on right (for unverified quotes)
- All extracted fields editable: supplier info, quote details, line items, totals
- Low-confidence fields visually highlighted
- Validation warnings displayed
- Save changes persists edits
- Approve changes status to approved and switches to read-only view
- Dashboard shows documents by status with counts
- RecentUploads supports approved status
</success_criteria>

<output>
After completion, create `.planning/phases/04-review-ui/04-03-SUMMARY.md`
</output>
