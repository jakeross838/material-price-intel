---
phase: 04-review-ui
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - material-price-intel/src/hooks/useQuoteReview.ts
  - material-price-intel/src/components/review/ConfidenceBadge.tsx
  - material-price-intel/src/components/review/ValidationWarnings.tsx
  - material-price-intel/src/components/review/ReviewForm.tsx
  - material-price-intel/src/components/review/LineItemsEditor.tsx
autonomous: true

must_haves:
  truths:
    - "User can edit supplier info, quote details, and totals in a form"
    - "User can edit, add, and remove line items in a table"
    - "Low-confidence fields are visually highlighted with yellow/orange"
    - "Validation warnings are displayed clearly to guide the reviewer"
    - "User can click Approve to commit reviewed data"
    - "User can click Save to persist edits without approving"
  artifacts:
    - path: "material-price-intel/src/hooks/useQuoteReview.ts"
      provides: "React hooks for approving quotes and saving review edits"
      exports: ["useApproveQuote", "useUpdateQuoteReview"]
    - path: "material-price-intel/src/components/review/ConfidenceBadge.tsx"
      provides: "Reusable confidence badge with color coding"
      min_lines: 10
    - path: "material-price-intel/src/components/review/ValidationWarnings.tsx"
      provides: "Warning display parsed from raw_extraction.validation_warnings"
      min_lines: 20
    - path: "material-price-intel/src/components/review/ReviewForm.tsx"
      provides: "Editable form for quote details, supplier info, totals, and line items"
      min_lines: 120
    - path: "material-price-intel/src/components/review/LineItemsEditor.tsx"
      provides: "Editable table for line items with add/remove capability"
      min_lines: 100
  key_links:
    - from: "useApproveQuote"
      to: "approve_quote RPC"
      via: "supabase.rpc('approve_quote')"
      pattern: "supabase\\.rpc.*approve_quote"
    - from: "useUpdateQuoteReview"
      to: "update_quote_review RPC"
      via: "supabase.rpc('update_quote_review')"
      pattern: "supabase\\.rpc.*update_quote_review"
    - from: "ReviewForm"
      to: "LineItemsEditor"
      via: "renders internally as a section"
      pattern: "import.*LineItemsEditor"
    - from: "ReviewForm"
      to: "useUpdateQuoteReview"
      via: "form onSubmit"
      pattern: "updateQuoteReview|onSave"
---

<objective>
Build the review form components and data hooks for the human review workflow.

Purpose: These are the building blocks of the review interface. They handle editing quote data, managing line items, displaying confidence scores and validation warnings, and saving/approving reviewed data. Plan 03 will integrate them into the QuoteDetailPage.

Output: A `useQuoteReview.ts` hook file, and four review components: ConfidenceBadge, ValidationWarnings, ReviewForm (which renders LineItemsEditor internally), and LineItemsEditor.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ai-extraction/03-02-SUMMARY.md
@.planning/phases/04-review-ui/04-01-PLAN.md

Key files:
@material-price-intel/src/lib/types.ts
@material-price-intel/src/lib/supabase.ts
@material-price-intel/src/pages/QuoteDetailPage.tsx
@material-price-intel/src/components/ui/button.tsx
@material-price-intel/src/components/ui/input.tsx
@material-price-intel/src/components/ui/card.tsx
@material-price-intel/src/components/ui/label.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create quote review hooks (useApproveQuote, useUpdateQuoteReview)</name>
  <files>material-price-intel/src/hooks/useQuoteReview.ts</files>
  <action>
Create `src/hooks/useQuoteReview.ts` with two React Query mutations:

**`useApproveQuote`:**
- Uses `useMutation` from `@tanstack/react-query`
- Calls `supabase.rpc('approve_quote', { p_quote_id: quoteId })`
- On success, invalidates query keys: `["quote", quoteId]` and `["documents", "recent"]`
- Returns standard mutation object (mutate, mutateAsync, isPending, isError, error)

**`useUpdateQuoteReview`:**
- Uses `useMutation` from `@tanstack/react-query`
- Accepts an object with all editable fields matching the `update_quote_review` RPC params:
  ```typescript
  type QuoteReviewUpdate = {
    quote_id: string;
    quote_number?: string | null;
    quote_date?: string | null;
    project_name?: string | null;
    payment_terms?: string | null;
    valid_until?: string | null;
    notes?: string | null;
    subtotal?: number | null;
    delivery_cost?: number | null;
    tax_amount?: number | null;
    tax_rate?: number | null;
    total_amount?: number | null;
    line_items?: Array<{
      raw_description: string;
      quantity: number | null;
      unit: string | null;
      unit_price: number | null;
      extended_price: number | null;
      discount_pct: number | null;
      discount_amount: number | null;
      line_total: number | null;
      notes: string | null;
    }>;
  };
  ```
- Note: No `supplier_name` field -- the `update_quote_review` RPC does not accept it (removed per checker review)
- Calls `supabase.rpc('update_quote_review', { p_quote_id, p_quote_number, ... p_line_items: JSON.stringify(line_items) })`
- On success, invalidates `["quote", quoteId]`, `["line_items", quoteId]`
- Returns standard mutation object

Both hooks should use `useQueryClient` for invalidation. Export the `QuoteReviewUpdate` type.

Import `supabase` from `@/lib/supabase`. Follow existing hook patterns (see `useUploadDocument.ts`).
  </action>
  <verify>
    1. File exists at `src/hooks/useQuoteReview.ts`
    2. Exports `useApproveQuote` and `useUpdateQuoteReview`
    3. Both use `supabase.rpc()` with correct function names
    4. `QuoteReviewUpdate` type does NOT include `supplier_name`
    5. Both invalidate appropriate query keys on success
    6. `npm run build` passes
  </verify>
  <done>
    Two mutation hooks exist for the review workflow: useApproveQuote calls approve_quote RPC and invalidates quote + document queries; useUpdateQuoteReview calls update_quote_review RPC with all editable fields including line items array (no dead supplier_name parameter).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create utility components (ConfidenceBadge + ValidationWarnings)</name>
  <files>
    material-price-intel/src/components/review/ConfidenceBadge.tsx
    material-price-intel/src/components/review/ValidationWarnings.tsx
  </files>
  <action>
Create two small utility components in `src/components/review/`:

**1. ConfidenceBadge.tsx** (extracted from QuoteDetailPage to be reusable):
```typescript
type ConfidenceBadgeProps = {
  score: number | null;
  size?: "sm" | "md";
};
```
- Renders a colored pill badge: green >= 80%, amber 60-79%, red < 60%
- Shows percentage text like "85% confidence"
- Uses Tailwind classes: `bg-green-100 text-green-800`, `bg-amber-100 text-amber-800`, `bg-red-100 text-red-800`
- Size "sm" for inline use, "md" for header
- Returns null if score is null

**2. ValidationWarnings.tsx:**
```typescript
type ValidationWarningsProps = {
  warnings: Array<{ check: string; message: string; expected?: number; actual?: number }>;
};
```
- Parse warnings from `quote.raw_extraction.validation_warnings`
- The validation warnings array comes from the Phase 3 validation module. Each warning has: `check` (e.g., "line_item_math", "subtotal_sum", "grand_total"), `message` (human-readable), and optionally `expected`/`actual` values
- Render as a collapsible alert box with amber/yellow background
- Show an AlertTriangle icon + count: "3 validation warnings"
- When expanded, list each warning with its message
- If no warnings or empty array, render nothing (return null)
- Use `useState` for collapse/expand toggle

Import icons from `lucide-react` (AlertTriangle, ChevronDown, ChevronUp).
  </action>
  <verify>
    1. Both files exist in `src/components/review/`
    2. ConfidenceBadge renders colored pill badge based on score thresholds
    3. ValidationWarnings renders collapsible warning list
    4. `npm run build` passes
  </verify>
  <done>
    ConfidenceBadge renders a colored confidence percentage pill (green/amber/red). ValidationWarnings renders a collapsible alert box listing extraction validation warnings. Both are self-contained utility components.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create interactive components (ReviewForm + LineItemsEditor)</name>
  <files>
    material-price-intel/src/components/review/ReviewForm.tsx
    material-price-intel/src/components/review/LineItemsEditor.tsx
  </files>
  <action>
Create two interactive components. **Important: ReviewForm renders LineItemsEditor internally** -- they are NOT siblings. The parent page (Plan 03) only renders ReviewForm.

**1. LineItemsEditor.tsx** (create first since ReviewForm imports it):
```typescript
export type EditableLineItem = {
  id: string; // temp ID for React key
  raw_description: string;
  quantity: number | null;
  unit: string | null;
  unit_price: number | null;
  line_total: number | null;
  notes: string | null;
  confidence?: number;
};

type LineItemsEditorProps = {
  items: EditableLineItem[];
  onChange: (items: EditableLineItem[]) => void;
};
```

- Renders an editable table of line items
- Columns: # (row number), Description (text input, wide), Qty (number input), Unit (text input, narrow), Unit Price (number input), Line Total (number input), Actions (delete button)
- Each row is a controlled form with inputs bound to the item state
- Description input should be wider (flex-1 or min-w-[200px])
- Number inputs should be narrower with `text-right tabular-nums` class
- Items with `confidence < 0.7` get a yellow-tinted background row
- "Add Line Item" button below the table -- adds a new empty row with a generated temp ID (`crypto.randomUUID()`)
- Delete button (Trash2 icon from lucide-react) on each row -- removes the item from array
- When any field changes, call `onChange` with the updated items array
- Export the `EditableLineItem` type so other components can use it

**2. ReviewForm.tsx** (renders LineItemsEditor internally):
```typescript
type ReviewFormProps = {
  quote: Quote & { suppliers: Pick<Supplier, "name" | "contact_name" | "contact_phone" | "contact_email" | "address"> };
  onSave: (data: QuoteReviewUpdate) => void;
  onApprove: () => void;
  isSaving: boolean;
  isApproving: boolean;
  lineItems: EditableLineItem[];
  onLineItemsChange: (items: EditableLineItem[]) => void;
};
```

- Renders FOUR sections in a single column layout (sits next to PDF in parent):
  1. **Quote Details** card: Editable fields for quote_number, quote_date, project_name, payment_terms, valid_until. Use shadcn Input + Label.
  2. **Supplier Info** card: Shows supplier name (read-only for now), contact_name, phone, email, address as read-only text.
  3. **Line Items** card: Renders `<LineItemsEditor items={lineItems} onChange={onLineItemsChange} />` internally.
  4. **Totals** card: Editable fields for subtotal, delivery_cost, tax_amount, tax_rate, total_amount. Number inputs.

- All editable fields use controlled inputs with local state initialized from props
- Fields with confidence < 0.7 get a yellow/orange left border or background tint to draw attention. Parse confidence from `quote.raw_extraction.extraction` -- each line item has a `confidence` field, and top-level fields use `overall_confidence`
- Two action buttons at bottom:
  - "Save Changes" (outline variant) -- calls onSave with current form state
  - "Approve Quote" (default/primary variant, green-ish) -- calls onApprove
- Both buttons show loading spinner when isSaving/isApproving

- Use existing shadcn components: Card, CardHeader, CardTitle, CardContent, Button, Input, Label
- Import `cn` from `@/lib/utils` for conditional classes
- Import `LineItemsEditor` from `./LineItemsEditor`
- Style: clean, minimal, consistent with existing QuoteDetailPage aesthetic

**IMPORTANT STYLING NOTES:**
- Use the existing shadcn UI primitives (Input, Button, Card, Label)
- Do NOT install any new dependencies
- Keep styling consistent with the existing QuoteDetailPage
- Use `@/` import alias for all imports
  </action>
  <verify>
    1. Both files exist in `src/components/review/`
    2. ReviewForm imports and renders LineItemsEditor internally
    3. ReviewForm accepts lineItems/onLineItemsChange props and passes them to LineItemsEditor
    4. LineItemsEditor renders editable table rows with add/delete
    5. ReviewForm renders editable quote details, read-only supplier info, line items, and totals
    6. `npm run build` passes with zero errors
    7. No new npm dependencies added
  </verify>
  <done>
    ReviewForm renders four sections (quote details, supplier info, line items via LineItemsEditor, totals) with save/approve buttons. LineItemsEditor provides an editable table with add/remove rows. ReviewForm renders LineItemsEditor internally -- the parent page only needs to render ReviewForm.
  </done>
</task>

</tasks>

<verification>
1. `useQuoteReview.ts` exports useApproveQuote and useUpdateQuoteReview (no supplier_name param)
2. ConfidenceBadge shows colored confidence percentage
3. ValidationWarnings displays collapsible warnings from raw_extraction
4. ReviewForm renders four sections including LineItemsEditor internally
5. LineItemsEditor renders editable table with add/remove line items
6. Low-confidence fields visually highlighted (yellow/orange)
7. `npm run build` passes cleanly with zero errors
8. No new npm dependencies
</verification>

<success_criteria>
- All review components render correctly and accept their typed props
- useApproveQuote calls approve_quote RPC
- useUpdateQuoteReview calls update_quote_review RPC with full data including line items (no dead supplier_name)
- ReviewForm renders LineItemsEditor internally (not siblings)
- Low-confidence fields have visual highlighting (yellow/orange border or background)
- Validation warnings are parsed and displayed from raw_extraction.validation_warnings
- Line items can be added, edited, and removed
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-review-ui/04-02-SUMMARY.md`
</output>
