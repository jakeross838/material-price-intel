---
phase: 09-smart-accuracy
plan: 04
type: execute
wave: 2
depends_on: ["09-01", "09-02"]
files_modified:
  - material-price-intel/supabase/migrations/011_backfill_line_types.sql
autonomous: true

must_haves:
  truths:
    - "User sees previously-imported discount lines (e.g. 'Volume Discount', 'Price Adjustment') correctly labeled as 'discount' in the Review UI, not as 'material'"
    - "User sees fee lines (e.g. 'Fuel Surcharge', 'Handling Fee') correctly labeled as 'fee' in the Review UI"
    - "User sees subtotal/total lines labeled as 'subtotal' so they are excluded from price comparisons"
    - "User sees informational text lines (terms, conditions) labeled as 'note' and dimmed"
    - "User sees accurate effective prices on existing material items (reflecting any inline discounts) in Search and Reports"
    - "User no longer sees non-material items polluting the Search results or price trend charts"
  artifacts:
    - path: "material-price-intel/supabase/migrations/011_backfill_line_types.sql"
      provides: "Data migration that reclassifies existing line items and computes effective prices"
      contains: "UPDATE line_items SET line_type"
  key_links:
    - from: "migrations/011_backfill_line_types.sql"
      to: "line_items table"
      via: "UPDATE with pattern matching"
      pattern: "UPDATE line_items SET line_type"
---

<objective>
Reclassify existing line items in the database with the new line_type system and compute effective_unit_price for all material items.

Purpose: Phase 9 requirement #7 specifies "Existing data migration: re-classify already-imported line items with the new type system without losing any data." The migration in Plan 01 defaulted all existing rows to 'material', which is safe but inaccurate. This migration uses SQL pattern matching to reclassify discount/fee/subtotal lines and compute effective prices.

Output: A SQL migration file that pattern-matches existing line items and reclassifies them.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@material-price-intel/supabase/migrations/002_schema.sql
@material-price-intel/supabase/migrations/010_line_type_and_effective_price.sql

# Prior plan context
@.planning/phases/09-smart-accuracy/09-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backfill migration to reclassify existing line items</name>
  <files>material-price-intel/supabase/migrations/011_backfill_line_types.sql</files>
  <action>
Create `material-price-intel/supabase/migrations/011_backfill_line_types.sql`:

```sql
-- ===========================================
-- BACKFILL: Reclassify existing line items
-- ===========================================
-- Phase 9 requirement: re-classify already-imported line items
-- with the new type system without losing any data.
--
-- Strategy: Pattern-match raw_description against common discount,
-- fee, subtotal, and note patterns. Conservative approach -- only
-- reclassify high-confidence matches; leave ambiguous items as 'material'
-- for human review.
-- ===========================================

-- -----------------------------------------------
-- 1. Reclassify DISCOUNT lines
-- -----------------------------------------------
-- Matches common discount descriptions. These typically have:
-- - Word "discount" in description
-- - Negative line_total
-- - discount_pct or discount_amount set
-- -----------------------------------------------
UPDATE line_items
SET line_type = 'discount'
WHERE line_type = 'material'
  AND (
    -- Description-based patterns (case-insensitive)
    LOWER(raw_description) ~ '^\s*(discount|price adjustment|loyalty credit|volume discount|customer discount|trade discount)'
    OR LOWER(raw_description) ~ '\b(discount|price reduction|credit applied|promotional credit)\s*$'
    OR (LOWER(raw_description) LIKE '%discount%' AND (line_total IS NULL OR line_total <= 0))
    -- Structural patterns: no qty/unit but has discount info
    OR (
      quantity IS NULL
      AND unit IS NULL
      AND unit_price IS NULL
      AND (discount_pct IS NOT NULL OR discount_amount IS NOT NULL)
    )
    -- Negative line_total with discount-like description
    OR (
      line_total < 0
      AND LOWER(raw_description) SIMILAR TO '%(discount|credit|adjustment|rebate|allowance)%'
    )
  );

-- -----------------------------------------------
-- 2. Reclassify FEE lines
-- -----------------------------------------------
-- Matches surcharges and fees that are not physical materials.
-- -----------------------------------------------
UPDATE line_items
SET line_type = 'fee'
WHERE line_type = 'material'
  AND (
    LOWER(raw_description) ~ '^\s*(minimum order|fuel surcharge|rush order|handling fee|restocking|setup fee|cutting fee|processing fee)'
    OR LOWER(raw_description) SIMILAR TO '%(surcharge|minimum charge|service fee|setup charge|processing charge|handling charge|environmental fee)%'
  )
  -- Safety: only reclassify if it looks fee-like (positive amount, no unit suggesting a material)
  AND (unit IS NULL OR LOWER(unit) NOT IN ('pc', 'lf', 'bf', 'sqft', 'ea', 'bundle', 'sheet'));

-- -----------------------------------------------
-- 3. Reclassify SUBTOTAL lines
-- -----------------------------------------------
-- Matches subtotal/section total descriptions.
-- -----------------------------------------------
UPDATE line_items
SET line_type = 'subtotal_line'
WHERE line_type = 'material'
  AND (
    LOWER(raw_description) ~ '^\s*(sub\s*total|section total|material total|lumber total|total|grand total)'
    OR LOWER(raw_description) SIMILAR TO '%(subtotal|sub total|section total)%'
  )
  -- Safety: subtotals typically have no quantity or unit
  AND quantity IS NULL
  AND unit IS NULL;

-- -----------------------------------------------
-- 4. Reclassify NOTE lines
-- -----------------------------------------------
-- Matches informational text with no pricing data.
-- -----------------------------------------------
UPDATE line_items
SET line_type = 'note'
WHERE line_type = 'material'
  AND unit_price IS NULL
  AND quantity IS NULL
  AND line_total IS NULL
  AND extended_price IS NULL
  AND (
    LOWER(raw_description) SIMILAR TO '%(prices valid|subject to|all lumber is|note:|terms:|conditions:|please note|prices subject)%'
    OR LENGTH(raw_description) > 100  -- Very long descriptions with no prices are likely notes
  );

-- -----------------------------------------------
-- 5. Compute effective_unit_price for ALL material items
-- -----------------------------------------------
-- This handles the common case where the material line itself has
-- discount_pct or discount_amount. Cross-line discount attribution
-- requires AI re-processing and cannot be done in SQL alone.
-- -----------------------------------------------
UPDATE line_items
SET effective_unit_price = CASE
  -- If discount_amount is set and quantity > 0, subtract per-unit discount
  WHEN discount_amount IS NOT NULL AND quantity IS NOT NULL AND quantity > 0
    THEN GREATEST(0, unit_price - (discount_amount / quantity))
  -- If discount_pct is set, apply percentage
  WHEN discount_pct IS NOT NULL
    THEN GREATEST(0, unit_price * (1 - discount_pct / 100))
  -- No discount: effective = raw
  ELSE unit_price
END
WHERE line_type = 'material'
  AND unit_price IS NOT NULL;

-- -----------------------------------------------
-- 6. Unlink non-material items from canonical materials
-- -----------------------------------------------
-- If any discount/fee/subtotal/note items were previously linked
-- to a canonical material by the normalization engine, unlink them.
-- This prevents discount lines from appearing in material price history.
-- -----------------------------------------------
UPDATE line_items
SET material_id = NULL
WHERE line_type != 'material'
  AND material_id IS NOT NULL;
```

**Design decisions:**
- Conservative: Only reclassify high-confidence pattern matches. Ambiguous items stay as 'material' and the user can reclassify via the Review UI (Plan 05).
- SQL SIMILAR TO and regex (~) for pattern matching -- both supported in PostgreSQL.
- Safety guards: Fee reclassification checks that the unit doesn't look like a material unit. Subtotal reclassification requires null quantity/unit.
- effective_unit_price only handles per-line discounts in SQL. Cross-line discount attribution requires AI and will only apply to future extractions.
- Section 6 unlinks any non-material items that were incorrectly normalized.
  </action>
  <verify>
Read the migration file and verify:
- 6 sections: discount, fee, subtotal_line, note reclassification + effective_unit_price computation + unlink non-materials
- Each reclassification has safety guards (doesn't blindly reclassify)
- effective_unit_price handles discount_amount and discount_pct cases
- GREATEST(0, ...) prevents negative effective prices
- Non-material items get material_id set to NULL
- No data is deleted -- only line_type, effective_unit_price, and material_id columns are modified
  </verify>
  <done>Migration reclassifies existing line items by pattern matching (discount, fee, subtotal, note), computes effective_unit_price for materials, and unlinks non-material items from canonical materials. All original data preserved.</done>
</task>

</tasks>

<verification>
- Migration file is syntactically valid SQL
- All 5 line_type values are handled (material is the default, discount/fee/subtotal_line/note are reclassified)
- effective_unit_price is computed for all material items
- Non-material items are unlinked from materials table
- No data loss possible (only UPDATE, no DELETE)
</verification>

<success_criteria>
1. Discount-like items (by description or negative amounts) reclassified as 'discount'
2. Fee-like items (surcharges, handling) reclassified as 'fee'
3. Subtotal-like items (with no qty/unit) reclassified as 'subtotal_line'
4. Note-like items (informational text, no pricing) reclassified as 'note'
5. All material items have effective_unit_price computed
6. Non-material items unlinked from canonical materials
</success_criteria>

<output>
After completion, create `.planning/phases/09-smart-accuracy/09-04-SUMMARY.md`
</output>
