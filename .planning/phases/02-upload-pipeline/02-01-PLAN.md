---
phase: 02-upload-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - material-price-intel/src/pages/UploadPage.tsx
  - material-price-intel/src/hooks/useUploadDocument.ts
  - material-price-intel/src/App.tsx
autonomous: false

user_setup:
  - service: supabase-storage
    why: "PDF file storage bucket needed for uploads"
    dashboard_config:
      - task: "Create storage bucket named 'documents' with private access"
        location: "Supabase Dashboard -> Storage -> New Bucket -> Name: 'documents', Public: OFF"
      - task: "Add storage policy for authenticated uploads"
        location: "Supabase Dashboard -> Storage -> documents bucket -> Policies -> New Policy -> Allow authenticated users to upload (INSERT) and read (SELECT) files in their org folder"

must_haves:
  truths:
    - "User can navigate to /upload page from sidebar"
    - "User can drag-and-drop a PDF file onto the upload area"
    - "User can click to browse and select a PDF file"
    - "Non-PDF files are rejected with an error message"
    - "Uploaded file is stored in Supabase Storage at a unique path"
    - "A document record is created in the database with status pending"
    - "Upload returns immediately to user with visual confirmation"
  artifacts:
    - path: "material-price-intel/src/pages/UploadPage.tsx"
      provides: "Drag-and-drop upload page with file validation and status feedback"
      min_lines: 80
    - path: "material-price-intel/src/hooks/useUploadDocument.ts"
      provides: "Upload logic: Storage upload + document record insertion"
      exports: ["useUploadDocument"]
    - path: "material-price-intel/src/App.tsx"
      provides: "Route for /upload"
      contains: "UploadPage"
  key_links:
    - from: "material-price-intel/src/pages/UploadPage.tsx"
      to: "material-price-intel/src/hooks/useUploadDocument.ts"
      via: "useUploadDocument hook call"
      pattern: "useUploadDocument"
    - from: "material-price-intel/src/hooks/useUploadDocument.ts"
      to: "supabase.storage"
      via: "Storage upload API"
      pattern: "supabase\\.storage\\.from.*upload"
    - from: "material-price-intel/src/hooks/useUploadDocument.ts"
      to: "supabase.from('documents')"
      via: "Database insert"
      pattern: "from\\(['\"]documents['\"]\\)\\.insert"
    - from: "material-price-intel/src/App.tsx"
      to: "material-price-intel/src/pages/UploadPage.tsx"
      via: "React Router route"
      pattern: "path=.*upload.*UploadPage"
---

<objective>
Build the core file upload pipeline: a drag-and-drop upload page that accepts PDF files, stores them in Supabase Storage, and creates a pending document record in the database.

Purpose: This is the entry point for the entire price intelligence system. Users drag a PDF quote into the app, and it gets stored and queued for processing. The upload must return immediately (no blocking).

Output: Working /upload route with drag-and-drop UI, Supabase Storage integration, and document record creation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 1 summaries for established patterns
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-03-SUMMARY.md

# Key source files
@material-price-intel/src/App.tsx
@material-price-intel/src/lib/supabase.ts
@material-price-intel/src/lib/types.ts
@material-price-intel/src/contexts/AuthContext.tsx
@material-price-intel/src/hooks/useAuth.ts
@material-price-intel/src/components/layout/AppLayout.tsx
@material-price-intel/src/pages/DashboardPage.tsx
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Create Supabase Storage bucket for documents</name>
  <action>
    The user needs to create a Storage bucket in the Supabase dashboard. This cannot be done from the client SDK with the anon key.
  </action>
  <how-to-verify>
    1. Go to https://supabase.com/dashboard/project/xgpjwpwhtfmbvoqtvete/storage/buckets
    2. Click "New Bucket"
    3. Name: `documents`
    4. Public bucket: OFF (private -- files accessed via signed URLs or RLS)
    5. Click "Create bucket"
    6. Go to the bucket's Policies tab
    7. Add a policy for INSERT (uploads): Allow authenticated users. Use this SQL for the policy:
       ```sql
       -- Allow authenticated users to upload to their org folder
       CREATE POLICY "auth_users_upload" ON storage.objects FOR INSERT
       TO authenticated
       WITH CHECK (bucket_id = 'documents');
       ```
    8. Add a policy for SELECT (downloads): Allow authenticated users to read files:
       ```sql
       CREATE POLICY "auth_users_read" ON storage.objects FOR SELECT
       TO authenticated
       USING (bucket_id = 'documents');
       ```

    Note: For v1 single-org use, simple authenticated policies are sufficient. Organization-level scoping in Storage can be added later if multi-tenant is needed. The file paths will include org_id as a folder prefix for organizational hygiene.
  </how-to-verify>
  <resume-signal>Type "bucket created" once the Storage bucket and policies are set up, or "skip" if you want to create it later (upload will fail without it).</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Create upload hook and upload page with drag-and-drop</name>
  <files>
    material-price-intel/src/hooks/useUploadDocument.ts
    material-price-intel/src/pages/UploadPage.tsx
    material-price-intel/src/App.tsx
  </files>
  <action>
    **Step 1: Create `src/hooks/useUploadDocument.ts`**

    Custom hook that handles the full upload flow. Uses React Query's `useMutation` for state management.

    The hook should:
    1. Accept no parameters (gets supabase client and auth from imports/context)
    2. Return a mutation object from `useMutation` with an `uploadDocument` function
    3. The `uploadDocument` function accepts a `File` object and:
       a. Validates file is PDF (check file.type === 'application/pdf')
       b. Generates a unique storage path: `{org_id}/{uuid}_{sanitized_filename}` where:
          - org_id comes from querying user_profiles for the current user's organization_id
          - uuid is crypto.randomUUID()
          - sanitized filename has spaces replaced with underscores
       c. Uploads the file to Supabase Storage bucket `documents`:
          ```typescript
          const { data, error } = await supabase.storage
            .from('documents')
            .upload(storagePath, file, {
              contentType: 'application/pdf',
              upsert: false,
            });
          ```
       d. On successful upload, inserts a document record:
          ```typescript
          const { data: doc, error: dbError } = await supabase
            .from('documents')
            .insert({
              organization_id: orgId,
              file_path: storagePath,
              file_type: 'pdf' as const,
              file_name: file.name,
              file_size_bytes: file.size,
              source: 'upload' as const,
              status: 'pending' as const,
              uploaded_by: user.id,
            })
            .select()
            .single();
          ```
       e. Returns the created document record

    Type the insert payload explicitly for compile-time safety: `const insertData: Database['public']['Tables']['documents']['Insert'] = { ... }` â€” this ensures the object shape matches the schema.

    4. To get org_id, query `user_profiles` table for current user:
       ```typescript
       const { data: profile } = await supabase
         .from('user_profiles')
         .select('organization_id')
         .eq('id', user.id)
         .single();
       ```
       Cache this result so it doesn't query on every upload. Use a simple module-level variable or useRef.
    5. Handle errors at each step: throw with descriptive messages ("Failed to upload file to storage", "Failed to create document record")
    6. If storage upload succeeds but DB insert fails, attempt to delete the orphaned storage file (best-effort cleanup)

    Import the supabase client from `@/lib/supabase`. Get user from `useAuth()` hook.

    **Step 2: Create `src/pages/UploadPage.tsx`**

    A clean upload page with drag-and-drop zone. Follow established patterns (named export, @/ imports, shadcn components).

    The page should have:
    1. A heading "Upload Quote" with a subtitle "Drag and drop a PDF quote to extract pricing data"
    2. A large drag-and-drop zone (dashed border, centered icon and text):
       - Default state: Upload cloud icon (use `Upload` from lucide-react), "Drag and drop your PDF here" text, and a "or click to browse" link/button
       - Drag-over state: Border color changes to primary, background tints, text changes to "Drop to upload"
       - Uploading state: Shows a spinner/loading indicator and "Uploading {filename}..." text
       - Success state: Check icon, "Uploaded successfully! Document is queued for processing." with the document status shown
       - Error state: AlertCircle icon, error message, "Try again" button
    3. File input (hidden, triggered by click on the drop zone):
       - accept="application/pdf,.pdf"
       - Only single file at a time
    4. File validation on drop/select:
       - Reject non-PDF files with message "Only PDF files are supported"
       - Reject files over 50MB with message "File size must be under 50MB"
    5. Uses the `useUploadDocument` hook for the actual upload
    6. After successful upload, show the success state for 3 seconds then reset to allow another upload

    Implement drag-and-drop using native HTML5 drag events (onDragEnter, onDragOver, onDragLeave, onDrop). Do NOT install react-dropzone -- keep dependencies minimal.

    Use shadcn Card as the container for the drop zone. Use the `cn()` utility from `@/lib/utils` for conditional classes.

    State machine for the drop zone:
    - `idle` -> drag file over -> `dragover`
    - `idle` -> drop file / select file -> `uploading`
    - `dragover` -> drag leave -> `idle`
    - `dragover` -> drop file -> `uploading`
    - `uploading` -> success -> `success`
    - `uploading` -> error -> `error`
    - `success` -> 3s timeout -> `idle`
    - `error` -> click retry -> `idle`

    **Step 3: Add route to `src/App.tsx`**

    Add the /upload route inside the ProtectedRoute > AppLayout group, alongside the dashboard route:
    ```tsx
    import { UploadPage } from "./pages/UploadPage";
    // ...
    <Route path="/upload" element={<UploadPage />} />
    ```
    Replace the comment `{/* Future routes: /upload, /quotes, /quotes/:id, /search */}` with the actual route and an updated comment for the remaining future routes.

    **Important patterns to follow:**
    - Named exports for pages (export function UploadPage)
    - All imports use @/ prefix
    - Use existing shadcn components (Card, Button) -- add more via `npx shadcn@latest add` if needed (e.g., progress, alert)
    - Use lucide-react for icons (Upload, CheckCircle, AlertCircle, FileText, Loader2)
    - Tailwind v4 classes for styling
  </action>
  <verify>
    1. `cd material-price-intel && npm run build` completes with zero TypeScript errors
    2. `npm run dev` -- navigate to /upload route, verify drag-and-drop zone renders
    3. Verify non-PDF file rejection: drag a .txt file, expect error message
    4. Verify the /upload nav link in sidebar navigates correctly and shows active state
  </verify>
  <done>
    - /upload route exists and is accessible from sidebar navigation
    - Drag-and-drop zone renders with proper states (idle, dragover, uploading, success, error)
    - useUploadDocument hook uploads file to Supabase Storage bucket 'documents' and creates a document record with status 'pending'
    - Non-PDF files are rejected client-side
    - Files over 50MB are rejected client-side
    - App builds with zero TypeScript errors
  </done>
</task>

</tasks>

<verification>
1. `npm run build` in material-price-intel/ passes with zero errors
2. Navigate to /upload -- page renders with drag-and-drop zone
3. Sidebar "Upload" link has active state when on /upload
4. Upload a real PDF file:
   a. File appears in Supabase Storage bucket under documents/{org_id}/{uuid}_{filename}
   b. Document record exists in documents table with status='pending', correct file_path, file_name, file_size_bytes
   c. Upload zone shows success state after upload completes
5. Drag a non-PDF file -- error message "Only PDF files are supported" appears
6. Upload zone resets to idle state after success (3 second delay)
</verification>

<success_criteria>
- PDF file upload stores file in Supabase Storage with unique path
- Document record created with status 'pending' and correct metadata
- Upload returns immediately to user with visual feedback
- Non-PDF files rejected client-side
- Zero TypeScript errors on build
</success_criteria>

<output>
After completion, create `.planning/phases/02-upload-pipeline/02-01-SUMMARY.md`
</output>
