---
phase: 03-ai-extraction
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - material-price-intel/src/hooks/useUploadDocument.ts

autonomous: false

user_setup:
  - service: anthropic
    why: "Claude API for PDF extraction"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys -> Create Key (https://console.anthropic.com/settings/keys)"
    dashboard_config:
      - task: "Add ANTHROPIC_API_KEY as Edge Function secret"
        location: "Supabase Dashboard -> Edge Functions -> Secrets, OR via CLI: supabase secrets set ANTHROPIC_API_KEY=sk-ant-..."

must_haves:
  truths:
    - "After a PDF is uploaded and the document record is created, the Edge Function is automatically invoked to start extraction"
    - "The client does NOT wait for extraction to complete -- it fires and forgets"
    - "ANTHROPIC_API_KEY is configured as a Supabase Edge Function secret"
  artifacts:
    - path: "material-price-intel/src/hooks/useUploadDocument.ts"
      provides: "Upload hook with Edge Function trigger after document creation"
      contains: "functions.invoke"
  key_links:
    - from: "useUploadDocument.ts"
      to: "process-document Edge Function"
      via: "supabase.functions.invoke('process-document')"
      pattern: "functions\\.invoke\\('process-document'"
---

<objective>
Wire the upload hook to automatically trigger the extraction Edge Function after a document is uploaded, and ensure the ANTHROPIC_API_KEY is configured.

Purpose: Closes the loop between upload (Phase 2) and extraction (Phase 3). After this plan, uploading a PDF triggers the full extraction pipeline automatically -- the user drops a PDF and walks away.

Output: Updated upload hook with Edge Function invocation. User has configured the Anthropic API key.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-upload-pipeline/02-01-SUMMARY.md

Existing files to reference:
@material-price-intel/src/hooks/useUploadDocument.ts
@material-price-intel/src/lib/supabase.ts
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Configure ANTHROPIC_API_KEY in Supabase</name>
  <what-built>The Edge Function (Plans 01 + 02) reads ANTHROPIC_API_KEY from Deno.env. This secret must be configured before the function can call Claude.</what-built>
  <action>
    You need to add your Anthropic API key as a Supabase Edge Function secret.

    **Option A: Via Supabase Dashboard**
    1. Go to https://supabase.com/dashboard/project/xgpjwpwhtfmbvoqtvete/settings/functions
    2. Under "Edge Function Secrets", click "Add new secret"
    3. Name: `ANTHROPIC_API_KEY`
    4. Value: Your Anthropic API key (starts with `sk-ant-...`)
    5. Save

    **Option B: Via Supabase CLI**
    ```bash
    cd material-price-intel
    supabase secrets set ANTHROPIC_API_KEY=sk-ant-your-key-here
    ```

    **Getting an API key (if you don't have one):**
    1. Go to https://console.anthropic.com/settings/keys
    2. Click "Create Key"
    3. Name it "Material Price Intel" or similar
    4. Copy the key

    NOTE: `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` are automatically available in Edge Functions -- you do NOT need to set those.
  </action>
  <resume-signal>Type "key configured" when the ANTHROPIC_API_KEY secret is set in Supabase</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Add Edge Function trigger to upload hook</name>
  <files>
    material-price-intel/src/hooks/useUploadDocument.ts
  </files>
  <action>
    Update the `useUploadDocument` hook to invoke the `process-document` Edge Function after a successful document upload.

    **Read the existing file first.** The current flow is:
    1. Validate file (type + size)
    2. Get org_id
    3. Upload to Storage
    4. Insert document record
    5. Return document

    **Add step 5.5:** After the document record is created successfully (we have `doc` with `doc.id`), fire-and-forget the Edge Function invocation:

    ```typescript
    // Fire-and-forget: trigger extraction pipeline
    // We intentionally don't await this -- the user doesn't need to wait for extraction
    supabase.functions.invoke('process-document', {
      body: { document_id: doc.id },
    }).catch((err) => {
      // Log but don't fail the upload -- extraction can be retried
      console.error('Failed to trigger extraction:', err);
    });
    ```

    **IMPORTANT considerations:**
    - Do NOT await the invocation. The upload should return immediately.
    - Do NOT throw if the invocation fails. The document is already uploaded and in 'pending' status. Extraction failure is handled separately (document goes to 'failed' status via the Edge Function's error handling).
    - The `.catch()` prevents unhandled promise rejection.
    - The Supabase client will automatically include the user's auth token in the Edge Function request, which the Edge Function can use to validate the request came from an authenticated user (though our Edge Function currently uses service role key for DB operations).

    **Do NOT change anything else in the hook.** The upload flow, error handling, and return values remain exactly the same. The Edge Function call is purely additive.

    Also add a brief comment above the fire-and-forget explaining that extraction status is tracked via Realtime (the RecentUploads component already shows status changes).
  </action>
  <verify>
    - `useUploadDocument.ts` contains `supabase.functions.invoke('process-document'`
    - The invocation is NOT awaited (fire-and-forget pattern)
    - The invocation has a `.catch()` handler
    - The invocation passes `{ document_id: doc.id }` in the body
    - The rest of the upload flow is unchanged
    - `npm run build` passes with zero errors
  </verify>
  <done>
    Upload hook triggers the extraction Edge Function after document creation. The call is fire-and-forget -- upload returns immediately to the user. Extraction progress is tracked via Realtime subscriptions (already built in Phase 2). Build passes.
  </done>
</task>

</tasks>

<verification>
1. `useUploadDocument.ts` invokes `process-document` Edge Function after document insert
2. Invocation is fire-and-forget (not awaited, has catch handler)
3. ANTHROPIC_API_KEY is configured in Supabase Edge Function secrets
4. `npm run build` passes
5. Full flow: upload PDF -> document created (pending) -> Edge Function invoked -> extraction runs -> status updates to completed/review_needed/failed -> Realtime pushes status to UI
</verification>

<success_criteria>
- Uploading a PDF triggers automatic extraction without additional user action
- Upload returns instantly to the user (no waiting for extraction)
- Extraction failures don't break the upload flow
- ANTHROPIC_API_KEY secret is configured and accessible to the Edge Function
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-extraction/03-03-SUMMARY.md`
</output>
