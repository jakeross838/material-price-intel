---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - material-price-intel/.env.local
  - material-price-intel/src/lib/supabase.ts
  - material-price-intel/src/hooks/useAuth.ts
  - material-price-intel/src/contexts/AuthContext.tsx
  - material-price-intel/src/components/auth/ProtectedRoute.tsx
  - material-price-intel/src/pages/LoginPage.tsx
  - material-price-intel/src/pages/DashboardPage.tsx
  - material-price-intel/src/App.tsx
  - material-price-intel/src/components/layout/AppLayout.tsx
autonomous: false
user_setup:
  - service: supabase
    why: "Database and authentication backend"
    env_vars:
      - name: VITE_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: VITE_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon/public key"
    dashboard_config:
      - task: "Create a Supabase project (or use existing Ross Built project)"
        location: "https://supabase.com/dashboard -> New Project"
      - task: "Enable pg_trgm extension"
        location: "Supabase Dashboard -> Database -> Extensions -> search 'pg_trgm' -> Enable"
      - task: "Run migration SQL files against the database"
        location: "Supabase Dashboard -> SQL Editor -> paste each migration file in order (001-005) and run, then seed.sql"
      - task: "Create a test user account via Supabase Auth"
        location: "Supabase Dashboard -> Authentication -> Users -> Add User (email + password)"

must_haves:
  truths:
    - "User can sign in with email and password on the login page"
    - "After signing in, user is redirected to the dashboard"
    - "Unauthenticated users are redirected to /login when accessing protected routes"
    - "User can sign out and is returned to the login page"
    - "Auth state persists across page refresh (session stored in localStorage)"
    - "Supabase client is configured and connects to the live project"
  artifacts:
    - path: "material-price-intel/src/lib/supabase.ts"
      provides: "Typed Supabase client singleton"
      contains: "createClient"
      min_lines: 5
    - path: "material-price-intel/src/contexts/AuthContext.tsx"
      provides: "React context for auth state (user, session, loading)"
      contains: "AuthContext"
      min_lines: 30
    - path: "material-price-intel/src/hooks/useAuth.ts"
      provides: "Hook for auth operations (signIn, signOut, user)"
      contains: "useAuth"
      min_lines: 10
    - path: "material-price-intel/src/components/auth/ProtectedRoute.tsx"
      provides: "Route guard that redirects to /login if not authenticated"
      contains: "Navigate"
      min_lines: 10
    - path: "material-price-intel/src/pages/LoginPage.tsx"
      provides: "Working login form with email/password"
      contains: "signIn"
      min_lines: 30
  key_links:
    - from: "material-price-intel/src/lib/supabase.ts"
      to: "Supabase project (cloud)"
      via: "VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY env vars"
      pattern: "createClient.*import\\.meta\\.env"
    - from: "material-price-intel/src/contexts/AuthContext.tsx"
      to: "material-price-intel/src/lib/supabase.ts"
      via: "Supabase auth state listener"
      pattern: "supabase\\.auth\\.onAuthStateChange"
    - from: "material-price-intel/src/components/auth/ProtectedRoute.tsx"
      to: "material-price-intel/src/contexts/AuthContext.tsx"
      via: "useAuth hook reads auth state"
      pattern: "useAuth"
    - from: "material-price-intel/src/App.tsx"
      to: "material-price-intel/src/components/auth/ProtectedRoute.tsx"
      via: "Protected routes wrapped in ProtectedRoute component"
      pattern: "ProtectedRoute"
---

<objective>
Wire Supabase authentication into the React app. Create the Supabase client, auth context, protected route guard, and working login/logout flow. After this plan, a user can sign in, see the dashboard, and sign out.

Purpose: This completes the Phase 1 foundation -- a running app with auth that connects to a real database with the full schema. Every subsequent phase builds features on top of this authenticated app shell.
Output: Working authentication flow with email/password login, protected routes, and persistent sessions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/research/STACK.md (Supabase auth patterns)
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: User sets up Supabase project and provides credentials</name>
  <action>
    The user needs to set up the Supabase project before the auth integration can work. This cannot be automated because it requires account access and project creation.
  </action>
  <instructions>
    Before proceeding, complete these steps:

    1. **Create or select a Supabase project:**
       - Go to https://supabase.com/dashboard
       - Create a new project (or identify the existing Ross Built project to use)
       - Wait for the project to finish provisioning

    2. **Enable pg_trgm extension:**
       - Go to Database -> Extensions
       - Search for "pg_trgm" and enable it

    3. **Run database migrations:**
       - Go to SQL Editor
       - Run each migration file IN ORDER:
         a. `supabase/migrations/001_extensions.sql`
         b. `supabase/migrations/002_schema.sql`
         c. `supabase/migrations/003_indexes.sql`
         d. `supabase/migrations/004_rls_policies.sql`
         e. `supabase/migrations/005_functions.sql`
         f. `supabase/seed.sql`

    4. **Create a test user:**
       - Go to Authentication -> Users -> Add User
       - Create a user with email and password for testing
       - NOTE: You also need to create an organization and user_profile row for this user.
         Run this in SQL Editor (replace values):
         ```sql
         INSERT INTO organizations (id, name) VALUES
           ('00000000-0000-0000-0000-000000000001', 'Ross Built Custom Homes');

         INSERT INTO user_profiles (id, organization_id, display_name, role) VALUES
           ('<paste-the-auth-user-uuid-here>', '00000000-0000-0000-0000-000000000001', 'Greg', 'admin');
         ```

    5. **Get API credentials:**
       - Go to Project Settings -> API
       - Copy the **Project URL** (e.g., `https://xxxxx.supabase.co`)
       - Copy the **anon/public** key

    6. **Provide credentials** by typing them when prompted so Claude can create the `.env.local` file.

    Type "ready" with your Supabase URL and anon key to continue.
  </instructions>
  <resume-signal>Type "ready" with your Supabase URL and anon key</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Create Supabase client and auth system</name>
  <files>
    material-price-intel/.env.local
    material-price-intel/src/lib/supabase.ts
    material-price-intel/src/contexts/AuthContext.tsx
    material-price-intel/src/hooks/useAuth.ts
    material-price-intel/src/components/auth/ProtectedRoute.tsx
  </files>
  <action>
    1. Create `material-price-intel/.env.local` with the Supabase credentials provided by the user:
       ```
       VITE_SUPABASE_URL=<provided-url>
       VITE_SUPABASE_ANON_KEY=<provided-key>
       ```
       Also add `.env.local` to `.gitignore` if not already there.

    2. Create `src/lib/supabase.ts` -- Typed Supabase client singleton:
       ```typescript
       import { createClient } from "@supabase/supabase-js";
       import type { Database } from "./types";

       const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
       const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

       if (!supabaseUrl || !supabaseAnonKey) {
         throw new Error("Missing VITE_SUPABASE_URL or VITE_SUPABASE_ANON_KEY environment variables");
       }

       export const supabase = createClient<Database>(supabaseUrl, supabaseAnonKey);
       ```

    3. Create `src/contexts/AuthContext.tsx`:
       - Create an AuthContext with React.createContext
       - AuthProvider component that:
         a. Tracks `user` (Supabase User | null), `session` (Session | null), `loading` (boolean)
         b. On mount, calls `supabase.auth.getSession()` to restore existing session
         c. Subscribes to `supabase.auth.onAuthStateChange()` for real-time auth updates
         d. Cleans up the subscription on unmount
         e. Provides `signIn(email, password)`, `signOut()`, `user`, `session`, `loading` via context
       - `signIn` calls `supabase.auth.signInWithPassword({ email, password })`
       - `signOut` calls `supabase.auth.signOut()`
       - While `loading` is true, render nothing or a loading spinner (prevents flash of login page)

    4. Create `src/hooks/useAuth.ts`:
       ```typescript
       import { useContext } from "react";
       import { AuthContext } from "../contexts/AuthContext";

       export function useAuth() {
         const context = useContext(AuthContext);
         if (!context) {
           throw new Error("useAuth must be used within an AuthProvider");
         }
         return context;
       }
       ```

    5. Create `src/components/auth/ProtectedRoute.tsx`:
       ```typescript
       import { Navigate, Outlet } from "react-router";
       import { useAuth } from "../../hooks/useAuth";

       export function ProtectedRoute() {
         const { user, loading } = useAuth();

         if (loading) {
           return (
             <div className="flex items-center justify-center min-h-screen">
               <div className="text-muted-foreground">Loading...</div>
             </div>
           );
         }

         if (!user) {
           return <Navigate to="/login" replace />;
         }

         return <Outlet />;
       }
       ```

    IMPORTANT: Use `@supabase/supabase-js` types -- import `User` and `Session` from `@supabase/supabase-js`.
    IMPORTANT: The auth state listener must handle the `SIGNED_OUT` event by clearing user/session state.
  </action>
  <verify>
    Run `npm run build` from `material-price-intel/` -- should compile without TypeScript errors. Verify that:
    - `supabase.ts` imports and uses the Database type from types.ts
    - `AuthContext.tsx` subscribes to auth state changes
    - `ProtectedRoute.tsx` correctly checks auth state
  </verify>
  <done>
    - `.env.local` created with Supabase credentials (gitignored)
    - Supabase client typed with Database interface
    - AuthContext provides user, session, loading, signIn, signOut
    - useAuth hook wraps context access with error boundary
    - ProtectedRoute redirects unauthenticated users to /login
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire auth into routes, build login form, add logout</name>
  <files>
    material-price-intel/src/App.tsx
    material-price-intel/src/main.tsx
    material-price-intel/src/pages/LoginPage.tsx
    material-price-intel/src/pages/DashboardPage.tsx
    material-price-intel/src/components/layout/AppLayout.tsx
  </files>
  <action>
    1. Update `src/main.tsx` to wrap the app with `AuthProvider`:
       ```typescript
       import { AuthProvider } from "./contexts/AuthContext";
       // ... existing imports ...

       ReactDOM.createRoot(document.getElementById("root")!).render(
         <React.StrictMode>
           <QueryClientProvider client={queryClient}>
             <BrowserRouter>
               <AuthProvider>
                 <App />
               </AuthProvider>
             </BrowserRouter>
           </QueryClientProvider>
         </React.StrictMode>
       );
       ```

    2. Update `src/App.tsx` to use ProtectedRoute:
       ```typescript
       import { Routes, Route } from "react-router";
       import { AppLayout } from "./components/layout/AppLayout";
       import { ProtectedRoute } from "./components/auth/ProtectedRoute";
       import { LoginPage } from "./pages/LoginPage";
       import { DashboardPage } from "./pages/DashboardPage";
       import { NotFoundPage } from "./pages/NotFoundPage";

       function App() {
         return (
           <Routes>
             <Route path="/login" element={<LoginPage />} />
             <Route element={<ProtectedRoute />}>
               <Route element={<AppLayout />}>
                 <Route path="/" element={<DashboardPage />} />
                 {/* Future routes: /upload, /quotes, /quotes/:id, /search */}
               </Route>
             </Route>
             <Route path="*" element={<NotFoundPage />} />
           </Routes>
         );
       }
       ```

    3. Rewrite `src/pages/LoginPage.tsx` with a real login form:
       - Centered card layout (max-w-sm, mx-auto, vertically centered)
       - App title/logo area: "Material Price Intel" heading
       - Email input field (type="email", required)
       - Password input field (type="password", required)
       - "Sign In" submit button using shadcn/ui Button component
       - Error message display (red text below button) for auth errors
       - Loading state on button while sign-in is in progress (disable button, show "Signing in...")
       - On successful sign-in, navigate to "/" using react-router's `useNavigate`
       - If user is already authenticated, redirect to "/" immediately (check useAuth)
       - Use shadcn/ui components where available: Button, Input (add via `npx shadcn@latest add input card label`)
       - Add shadcn Card, Input, Label components if not already added:
         ```
         npx shadcn@latest add card input label
         ```

    4. Update `src/components/layout/AppLayout.tsx` to add logout:
       - Import and use `useAuth` hook
       - Display the user's email in the sidebar footer area
       - Add a "Sign Out" button (shadcn Button, variant="ghost") that calls `signOut()`
       - After sign out, the ProtectedRoute will automatically redirect to /login

    5. Update DashboardPage to show something useful:
       - Display "Welcome, {user.email}" using useAuth hook
       - Show the organization name if available (query from user_profiles if desired, or just show placeholder)
       - Brief description: "Upload supplier quotes to build your pricing database."

    IMPORTANT: The login form should handle both form submission and error display gracefully. Use React state for email, password, error, and loading.
    IMPORTANT: After successful signIn, use `navigate("/", { replace: true })` to avoid the login page staying in browser history.
  </action>
  <verify>
    1. Run `npm run dev` and open http://localhost:5173/
    2. Should redirect to /login (not authenticated yet)
    3. Enter the test user email and password created in Task 1
    4. Click "Sign In" -- should redirect to / (dashboard)
    5. Dashboard shows "Welcome, {email}" text
    6. Sidebar shows user email and "Sign Out" button
    7. Click "Sign Out" -- should redirect to /login
    8. Refresh the page at / -- should stay on dashboard (session persisted)
    9. Open a new incognito window at / -- should redirect to /login
    10. `npm run build` completes without errors
  </verify>
  <done>
    - Login form accepts email/password and authenticates via Supabase Auth
    - Successful login redirects to dashboard
    - Protected routes redirect to /login when not authenticated
    - Sign out clears session and redirects to /login
    - Auth state persists across page refresh
    - User email displayed in sidebar and dashboard
    - No TypeScript compilation errors
  </done>
</task>

</tasks>

<verification>
Complete auth flow test:
1. Open app in browser -- redirects to /login
2. Sign in with test credentials -- lands on dashboard
3. Refresh page -- stays on dashboard (session persists)
4. Navigate to /nonexistent -- shows 404
5. Sign out -- redirects to /login
6. Try to visit / directly -- redirects to /login
7. Sign in again -- works
8. `npm run build` -- zero errors
</verification>

<success_criteria>
- Supabase client connects to live project with typed Database interface
- Email/password login works via Supabase Auth
- Protected routes redirect unauthenticated users to /login
- Auth state persists across page refreshes (session in localStorage)
- User can sign out and is redirected to /login
- Login form shows error messages for invalid credentials
- All Phase 1 success criteria from ROADMAP.md are met:
  1. Supabase project has all tables created with proper indexes and foreign keys
  2. pg_trgm extension enabled and GIN indexes created
  3. RLS policies enforce row-level security on all tables
  4. React app boots with Vite, routes to login/dashboard, authenticates via Supabase Auth
  5. Material schema supports structured fields with extensible categories
  6. Delivery cost and tax fields exist as separate quote-level columns
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
