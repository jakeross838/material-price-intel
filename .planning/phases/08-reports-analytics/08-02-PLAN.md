---
phase: 08-reports-analytics
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - material-price-intel/src/components/reports/PriceTrendChart.tsx
  - material-price-intel/src/pages/ReportsPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can see an interactive line chart with unit prices over time"
    - "Multiple supplier lines appear on the same chart in different colors"
    - "Clicking a data point on the chart navigates to the original quote"
    - "Chart renders smoothly with existing data volume"
    - "When a specific material is selected, chart shows that material's price history per supplier"
    - "When no specific material is selected, chart shows average price per supplier over time"
  artifacts:
    - path: "material-price-intel/src/components/reports/PriceTrendChart.tsx"
      provides: "Recharts line chart component with multi-supplier lines and click-to-quote"
      exports: ["PriceTrendChart"]
      min_lines: 80
    - path: "material-price-intel/src/pages/ReportsPage.tsx"
      provides: "Updated page with PriceTrendChart replacing placeholder"
      contains: "PriceTrendChart"
  key_links:
    - from: "material-price-intel/src/components/reports/PriceTrendChart.tsx"
      to: "recharts"
      via: "import { LineChart, Line, XAxis, YAxis, ... }"
      pattern: "from.*recharts"
    - from: "material-price-intel/src/components/reports/PriceTrendChart.tsx"
      to: "react-router"
      via: "useNavigate for click-to-quote"
      pattern: "useNavigate|navigate.*quotes"
    - from: "material-price-intel/src/pages/ReportsPage.tsx"
      to: "material-price-intel/src/components/reports/PriceTrendChart.tsx"
      via: "import and render"
      pattern: "PriceTrendChart"
---

<objective>
Build the interactive multi-supplier price trend line chart using Recharts and integrate it into the ReportsPage, replacing the placeholder from Plan 01.

Purpose: This is the core analytics visualization -- seeing price trends over time with supplier comparison is the primary deliverable of Phase 8. Users can visually compare what different suppliers charge for the same material and click through to the original quote.
Output: A working PriceTrendChart component rendered in the Reports page showing price-over-time with colored supplier lines and click-to-quote navigation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-reports-analytics/08-01-SUMMARY.md
@material-price-intel/src/pages/ReportsPage.tsx
@material-price-intel/src/hooks/useReportsData.ts
@material-price-intel/src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PriceTrendChart component</name>
  <files>
    material-price-intel/src/components/reports/PriceTrendChart.tsx
  </files>
  <action>
    Create `src/components/reports/PriceTrendChart.tsx`. This is a self-contained chart component that receives filtered data and renders a Recharts LineChart.

    **Props:**
    ```typescript
    import type { ReportDataPoint } from "@/hooks/useReportsData";

    type PriceTrendChartProps = {
      data: ReportDataPoint[];
      onPointClick?: (quoteId: string) => void;
    };
    ```

    **Data Transformation:**
    The component must transform the flat `ReportDataPoint[]` into Recharts-compatible format. Recharts LineChart expects an array of objects where each object is one x-axis point, with keys for each series.

    Steps:
    1. Group data points by `quoteDate` (the x-axis). For points with the same date AND same supplier, average their unit prices (a single quote might have multiple line items for the same material).
    2. Get unique supplier names from the data. Assign each a color from a predefined palette:
       ```typescript
       const SUPPLIER_COLORS = [
         "#2563eb", // blue-600
         "#dc2626", // red-600
         "#16a34a", // green-600
         "#9333ea", // purple-600
         "#ea580c", // orange-600
         "#0891b2", // cyan-600
         "#c026d3", // fuchsia-600
         "#854d0e", // yellow-800
       ];
       ```
    3. Build the chart data array:
       ```typescript
       type ChartPoint = {
         date: string;           // formatted date for x-axis
         sortDate: string;       // raw ISO date for sorting
         [supplierName: string]: number | string | undefined; // price per supplier
         // Also store quote IDs for click-to-quote:
         _quoteIds?: Record<string, string>; // supplierName -> quoteId
       };
       ```
       For each unique date, create one ChartPoint with supplier names as keys and their (averaged) unit price as values. Store the quoteId mapping in a `_quoteIds` field (prefixed with underscore so Recharts ignores it).
    4. Sort chart data by `sortDate` ascending.

    **Recharts Rendering:**
    Use `ResponsiveContainer` wrapping a `LineChart`:
    ```tsx
    import {
      LineChart,
      Line,
      XAxis,
      YAxis,
      CartesianGrid,
      Tooltip,
      Legend,
      ResponsiveContainer,
    } from "recharts";
    ```

    Configuration:
    - `ResponsiveContainer` with `width="100%"` and `height={400}`
    - `LineChart` with `data={chartData}` and `margin={{ top: 5, right: 30, left: 20, bottom: 5 }}`
    - `CartesianGrid` with `strokeDasharray="3 3"` and `className="stroke-border"`
    - `XAxis` with `dataKey="date"`, `tick={{ fontSize: 12 }}`, `className="text-muted-foreground"`
    - `YAxis` with `tickFormatter` that formats as `$X.XX`, `tick={{ fontSize: 12 }}`, `className="text-muted-foreground"`. Add `domain={['auto', 'auto']}` so the axis auto-scales.
    - `Tooltip` with a custom content renderer that shows:
      - Date as header
      - Each supplier's price formatted as currency
      - Styled with card-like appearance (bg-popover, border, rounded, shadow)
    - `Legend` at the bottom
    - One `Line` per supplier:
      ```tsx
      {suppliers.map((supplier, i) => (
        <Line
          key={supplier}
          type="monotone"
          dataKey={supplier}
          stroke={SUPPLIER_COLORS[i % SUPPLIER_COLORS.length]}
          strokeWidth={2}
          dot={{ r: 4, cursor: "pointer" }}
          activeDot={{ r: 6, cursor: "pointer" }}
          connectNulls
        />
      ))}
      ```

    **Click-to-Quote:**
    Add an `onClick` handler to the `LineChart`:
    ```tsx
    onClick={(e) => {
      if (e?.activePayload?.[0]?.payload?._quoteIds && onPointClick) {
        // Find which supplier line was closest / clicked
        // Use the first supplier's quoteId from the active point
        const quoteIds = e.activePayload[0].payload._quoteIds;
        const firstQuoteId = Object.values(quoteIds)[0];
        if (firstQuoteId) onPointClick(firstQuoteId as string);
      }
    }}
    ```

    For a more precise click: In the custom Tooltip, render each supplier row as a clickable element that calls `onPointClick` with that specific supplier's quoteId. This gives exact supplier-level drill-down rather than ambiguous "closest line" detection.

    **Empty state:**
    If `data.length === 0`, render a centered message: "Select a material or apply filters to see price trends" with a BarChart3 icon from lucide-react, same empty-state styling as other pages.

    **Format dates for display:**
    Use `date-fns` (already installed) to format dates. Import `format` from "date-fns" and format `quoteDate` as `"MMM d, yyyy"` for x-axis labels and tooltip headers.

    Export: `export function PriceTrendChart({ data, onPointClick }: PriceTrendChartProps)`
  </action>
  <verify>
    1. Run `cd material-price-intel && npx tsc --noEmit` -- no TypeScript errors
    2. Run `cd material-price-intel && npm run build` -- build succeeds
    3. Verify PriceTrendChart.tsx imports from "recharts"
    4. Verify PriceTrendChart.tsx has onPointClick prop handling
    5. Verify PriceTrendChart.tsx uses ResponsiveContainer, LineChart, Line, XAxis, YAxis, Tooltip, Legend
  </verify>
  <done>
    PriceTrendChart component exists, accepts ReportDataPoint[] and onPointClick callback, renders a Recharts LineChart with one colored Line per supplier, formatted axes, custom tooltip, and click-to-quote support. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate PriceTrendChart into ReportsPage</name>
  <files>
    material-price-intel/src/pages/ReportsPage.tsx
  </files>
  <action>
    Update `ReportsPage.tsx` to replace the chart placeholder Card from Plan 01 with the real `PriceTrendChart` component.

    **Import:**
    ```tsx
    import { PriceTrendChart } from "@/components/reports/PriceTrendChart";
    import { useNavigate } from "react-router";
    ```

    **Navigation handler:**
    ```tsx
    const navigate = useNavigate();
    const handlePointClick = (quoteId: string) => {
      navigate(`/quotes/${quoteId}`);
    };
    ```

    **Replace the placeholder Card** with:
    ```tsx
    <Card>
      <CardHeader>
        <CardTitle className="text-lg flex items-center gap-2">
          <TrendingUp className="h-5 w-5" />
          Price Trends
          {materialFilter && (
            <span className="text-sm font-normal text-muted-foreground ml-2">
              â€” {/* show selected material name */}
            </span>
          )}
        </CardTitle>
      </CardHeader>
      <CardContent>
        <PriceTrendChart
          data={filteredData}
          onPointClick={handlePointClick}
        />
      </CardContent>
    </Card>
    ```

    Show the selected material's canonical name in the card title when a specific material filter is active. Derive this from the materials list: `const selectedMaterialName = materials?.find(m => m.id === materialFilter)?.canonical_name ?? null;`

    **Chart behavior based on filter state:**
    The chart automatically adapts because PriceTrendChart groups by supplier. When:
    - A specific material is selected: chart shows that material's price per supplier over time (the ideal view)
    - No material selected but category selected: chart shows all materials in that category (may be noisy -- acceptable for v1)
    - No filters: chart shows all data (overview)

    Add a hint below the chart when no material is selected:
    ```tsx
    {!materialFilter && (
      <p className="text-xs text-muted-foreground text-center mt-2">
        Tip: Select a specific material above for the clearest supplier comparison
      </p>
    )}
    ```

    **Also add a data table below the chart** -- a simple table (same styling as SearchPage) showing the filtered data points with columns: Date, Material, Supplier, Unit Price, Quote #, and a link icon to the quote. This provides tabular access alongside the visual chart. Limit to most recent 50 rows with a "Showing X of Y" indicator.

    Table columns:
    - Date: formatted with date-fns as "MMM d, yyyy"
    - Material: canonical_name
    - Supplier: supplier name
    - Unit Price: formatted as $X.XX
    - Quote: link to /quotes/{quoteId} using Button variant="ghost" size="icon-xs" with ExternalLink icon

    Sort by quoteDate descending (newest first) for the table.
  </action>
  <verify>
    1. Run `cd material-price-intel && npx tsc --noEmit` -- no TypeScript errors
    2. Run `cd material-price-intel && npm run build` -- build succeeds
    3. Verify ReportsPage.tsx imports PriceTrendChart
    4. Verify ReportsPage.tsx imports useNavigate and has handlePointClick
    5. Verify ReportsPage.tsx renders a data table below the chart
    6. Grep for "PriceTrendChart" in ReportsPage.tsx -- should appear in JSX
  </verify>
  <done>
    ReportsPage renders the PriceTrendChart with filtered data and click-to-quote navigation. A data table below the chart shows the same filtered data in tabular form with links to quotes. The chart title shows the selected material name when filtered. Build passes cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` in material-price-intel/ passes with zero errors
2. PriceTrendChart.tsx exists in src/components/reports/
3. ReportsPage.tsx imports and renders PriceTrendChart
4. Chart has one Line per supplier with distinct colors
5. Custom tooltip displays formatted prices per supplier
6. Clicking a chart point navigates to /quotes/{id}
7. Data table below chart shows filtered results with quote links
8. Chart adapts to filter state (specific material = cleanest view)
</verification>

<success_criteria>
- Interactive Recharts LineChart renders on the Reports page
- Multiple supplier lines appear with different colors
- X-axis shows quote dates, Y-axis shows unit prices formatted as currency
- Tooltip shows per-supplier prices for hovered date
- Click-to-quote navigates to the original quote detail page
- Data table provides tabular view of the same filtered data
- Chart hint encourages specific material selection for best comparison
- TypeScript compiles cleanly, Vite build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/08-reports-analytics/08-02-SUMMARY.md`
</output>
