---
phase: 08-reports-analytics
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - material-price-intel/src/components/reports/CategoryAggregateChart.tsx
  - material-price-intel/src/pages/ReportsPage.tsx
autonomous: false

must_haves:
  truths:
    - "User can view category-level aggregate price trends (e.g., average lumber price over time)"
    - "Category chart shows average price per category over time when no specific material is selected"
    - "Switching between material chart and category chart is intuitive"
    - "Category chart is not misleadingly filtered by a single material selection"
    - "The full Reports page works end-to-end: filters, stats, charts, drill-down"
  artifacts:
    - path: "material-price-intel/src/components/reports/CategoryAggregateChart.tsx"
      provides: "Recharts line chart showing average price per category over time"
      exports: ["CategoryAggregateChart"]
      min_lines: 60
    - path: "material-price-intel/src/pages/ReportsPage.tsx"
      provides: "Updated page with category chart integrated"
      contains: "CategoryAggregateChart"
  key_links:
    - from: "material-price-intel/src/components/reports/CategoryAggregateChart.tsx"
      to: "recharts"
      via: "import Recharts components"
      pattern: "from.*recharts"
    - from: "material-price-intel/src/pages/ReportsPage.tsx"
      to: "material-price-intel/src/components/reports/CategoryAggregateChart.tsx"
      via: "import and conditional render"
      pattern: "CategoryAggregateChart"
---

<objective>
Build the category-level aggregate price chart and integrate it into the Reports page, then verify the complete analytics dashboard end-to-end.

Purpose: Completes the analytics story -- users can see not just individual material prices, but category-wide trends (e.g., "is lumber getting more expensive overall?"). This is the final deliverable of v1.
Output: A complete Reports page with both material-level and category-level chart views, plus a human verification checkpoint confirming everything works.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-reports-analytics/08-01-SUMMARY.md
@.planning/phases/08-reports-analytics/08-02-SUMMARY.md
@material-price-intel/src/pages/ReportsPage.tsx
@material-price-intel/src/hooks/useReportsData.ts
@material-price-intel/src/components/reports/PriceTrendChart.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CategoryAggregateChart and integrate into ReportsPage</name>
  <files>
    material-price-intel/src/components/reports/CategoryAggregateChart.tsx
    material-price-intel/src/pages/ReportsPage.tsx
  </files>
  <action>
    **Step 1: Create `src/components/reports/CategoryAggregateChart.tsx`**

    This chart shows average prices per material CATEGORY over time -- a higher-level view than the per-supplier PriceTrendChart.

    **Props:**
    ```typescript
    import type { ReportDataPoint } from "@/hooks/useReportsData";

    type CategoryAggregateChartProps = {
      data: ReportDataPoint[];
      categories: Array<{ id: string; display_name: string }>;
      onPointClick?: (quoteId: string) => void;
    };
    ```

    **Data Transformation:**
    1. Group data points by `quoteDate` AND `categoryId`.
    2. For each date + category combination, compute the average `unitPrice` across all data points in that group.
    3. Get unique category IDs from the data. Map each to its `display_name` from the categories prop for labeling.
    4. Assign colors from a category-specific palette:
       ```typescript
       const CATEGORY_COLORS = [
         "#2563eb", // blue-600
         "#dc2626", // red-600
         "#16a34a", // green-600
         "#9333ea", // purple-600
         "#ea580c", // orange-600
         "#0891b2", // cyan-600
         "#c026d3", // fuchsia-600
         "#854d0e", // yellow-800
       ];
       ```
    5. Build chart data: each point is `{ date: string, sortDate: string, [categoryDisplayName]: averagePrice, _quoteIds: { [categoryDisplayName]: anyQuoteIdFromThatGroup } }`.
    6. Sort by sortDate ascending.

    **Rendering:**
    Same Recharts pattern as PriceTrendChart:
    - `ResponsiveContainer` width="100%" height={350}
    - `LineChart` with same margins
    - `CartesianGrid` with strokeDasharray="3 3"
    - `XAxis` with date, `YAxis` with currency formatter
    - `Tooltip` with custom content showing category name + average price
    - `Legend`
    - One `Line` per category with `type="monotone"`, `strokeWidth={2}`, `connectNulls`

    Use `format` from date-fns for date display.

    **Click behavior:**
    On click, navigate to the first quote in that category+date group (good enough for drill-down in v1).

    **Empty state:**
    If data is empty, render a centered message: "No category data available. Ensure materials are linked to categories."

    **Step 2: Integrate into ReportsPage.tsx**

    Add a chart view toggle to switch between "Supplier Comparison" and "Category Trends" views.

    Implementation:
    ```tsx
    const [chartView, setChartView] = useState<"supplier" | "category">("supplier");
    ```

    Add toggle buttons above the chart card:
    ```tsx
    <div className="flex gap-2">
      <Button
        variant={chartView === "supplier" ? "default" : "outline"}
        size="sm"
        onClick={() => setChartView("supplier")}
      >
        Supplier Comparison
      </Button>
      <Button
        variant={chartView === "category" ? "default" : "outline"}
        size="sm"
        onClick={() => setChartView("category")}
      >
        Category Trends
      </Button>
    </div>
    ```

    **IMPORTANT: Category chart data must NOT be filtered by materialFilter.**

    When `chartView === "category"`, passing `filteredData` (which includes materialFilter) would show a misleading single-material "category average". Instead, create a separate `categoryChartData` that applies all filters EXCEPT materialFilter:

    ```typescript
    const categoryChartData = useMemo(() => {
      return reportData.filter(item => {
        if (categoryFilter !== "all" && item.categoryId !== categoryFilter) return false;
        if (supplierFilter !== "all" && item.supplierName !== supplierFilter) return false;
        if (dateFrom && item.quoteDate && item.quoteDate < dateFrom) return false;
        if (dateTo && item.quoteDate && item.quoteDate > dateTo) return false;
        // NOTE: materialFilter intentionally NOT applied here
        return true;
      });
    }, [reportData, categoryFilter, supplierFilter, dateFrom, dateTo]);
    ```

    Conditionally render based on `chartView`:
    - "supplier": Render `PriceTrendChart` with `filteredData` (includes all filters including material)
    - "category": Render `CategoryAggregateChart` with `categoryChartData` (excludes material filter)

    When `chartView === "category"` AND `materialFilter !== "all"`, show an info note below the toggle:
    ```tsx
    {chartView === "category" && materialFilter !== "all" && (
      <p className="text-xs text-muted-foreground italic">
        Showing all materials in category â€” material filter applies to Supplier Comparison view only
      </p>
    )}
    ```

    Update the Card title to reflect the view:
    - "supplier": "Price Trends -- Supplier Comparison"
    - "category": "Price Trends -- Category Averages"

    **Pass categories to CategoryAggregateChart:**
    ```tsx
    <CategoryAggregateChart
      data={categoryChartData}
      categories={(categories ?? []).map(c => ({ id: c.id, display_name: c.display_name }))}
      onPointClick={handlePointClick}
    />
    ```
  </action>
  <verify>
    1. Run `cd material-price-intel && npx tsc --noEmit` -- no TypeScript errors
    2. Run `cd material-price-intel && npm run build` -- build succeeds
    3. Verify CategoryAggregateChart.tsx exists and exports CategoryAggregateChart
    4. Verify ReportsPage.tsx imports CategoryAggregateChart
    5. Verify ReportsPage.tsx has chartView state with "supplier" and "category" options
    6. Grep for "Category Trends" in ReportsPage.tsx -- button text present
    7. Grep for "categoryChartData" in ReportsPage.tsx -- separate dataset for category view exists
    8. Confirm categoryChartData useMemo does NOT reference materialFilter
    9. Grep for "Showing all materials in category" in ReportsPage.tsx -- info note present
  </verify>
  <done>
    CategoryAggregateChart renders average prices per category over time. ReportsPage has toggle buttons to switch between Supplier Comparison and Category Trends views. Category chart uses a separate dataset that excludes materialFilter to avoid misleading single-material category averages. An info note appears when material filter is active in category view. Both charts support click-to-quote navigation. Build passes cleanly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete Reports dashboard end-to-end</name>
  <what-built>
    Complete Reports & Price Analytics Dashboard (Phase 8, the final v1 phase):
    - Reports page accessible via /reports route and sidebar navigation
    - Filter panel: category, material, supplier, date-from, date-to
    - Summary stat cards: average price, price trend direction, best supplier, quote count
    - Supplier Comparison chart: interactive line chart with multi-supplier lines in different colors
    - Category Trends chart: aggregate average price per category over time
    - Toggle between chart views (Supplier Comparison / Category Trends)
    - Click-to-quote: clicking a data point navigates to the original quote
    - Category chart correctly ignores material filter to show true category-level aggregates
  </what-built>
  <how-to-verify>
    1. Start dev server: `cd material-price-intel && npm run dev`
    2. Navigate to http://localhost:5173/reports
    3. Verify the page loads with stat cards and chart
    4. Test filter panel:
       a. Select a material category -- stat cards and chart should update
       b. Select a specific material -- chart should show per-supplier price lines
       c. Select a supplier -- chart should filter to that supplier only
       d. Set date range -- data should filter within range
       e. Click "Clear Filters" -- everything resets
    5. Verify stat cards:
       a. Average Price shows a dollar amount
       b. Price Trend shows Rising/Falling/Stable with percentage
       c. Best Supplier shows the lowest-average-price supplier name
       d. Quote Count shows number of unique quotes
    6. Test chart interactions:
       a. Hover over data points -- tooltip shows date and per-supplier/category prices
       b. Click a data point -- should navigate to /quotes/{id}
       c. Toggle between "Supplier Comparison" and "Category Trends" views
    7. Test category chart isolation:
       a. Select a specific material in the filter
       b. Switch to "Category Trends" view
       c. Verify the chart shows ALL materials in the category (not just the selected one)
       d. Verify the info note "Showing all materials in category..." appears
    8. Verify sidebar has "Reports" link with chart icon
    9. Check mobile responsiveness: resize browser to ~375px width, verify layout stacks properly
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` in material-price-intel/ passes with zero errors
2. CategoryAggregateChart.tsx exists in src/components/reports/
3. ReportsPage.tsx renders both PriceTrendChart and CategoryAggregateChart conditionally
4. Chart view toggle switches between supplier and category views
5. Category chart uses separate data that excludes material filter
6. All 7 phase success criteria are met:
   - [x] Interactive line charts with unit prices over time
   - [x] Multiple supplier lines with different colors
   - [x] Filter by category, material, supplier, date range
   - [x] Category-level aggregate view
   - [x] Summary stat cards (avg, trend, best supplier, count)
   - [x] Click data point -> navigate to quote
   - [x] Chart renders smoothly (Recharts + ResponsiveContainer)
</verification>

<success_criteria>
- CategoryAggregateChart renders category-level average prices over time
- Toggle between Supplier Comparison and Category Trends views works
- Category chart ignores material filter to show true category aggregates
- Info note appears when material filter is active in category view
- All Phase 8 success criteria met (7/7)
- Human verifies the full analytics dashboard works end-to-end
- v1 milestone complete -- all 8 phases delivered
</success_criteria>

<output>
After completion, create `.planning/phases/08-reports-analytics/08-03-SUMMARY.md`
</output>
