---
phase: 10-estimating-procurement
plan: 06
type: execute
wave: 6
depends_on: ["10-05"]
files_modified:
  - material-price-intel/src/components/projects/BudgetDashboard.tsx
  - material-price-intel/src/components/projects/VarianceChart.tsx
  - material-price-intel/src/pages/ProjectDetailPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can see budget vs actual variance at project, room, and category levels"
    - "Over-budget items are highlighted in red, under-budget in green"
    - "A visual chart shows variance by room or category"
    - "Project-level totals show allowance, estimated, actual, and variance"
    - "Budget tab replaces placeholder on ProjectDetailPage"
  artifacts:
    - path: "material-price-intel/src/components/projects/BudgetDashboard.tsx"
      provides: "Multi-level budget vs actual variance display"
      min_lines: 120
    - path: "material-price-intel/src/components/projects/VarianceChart.tsx"
      provides: "Recharts bar chart showing variance by room/category"
      min_lines: 50
  key_links:
    - from: "material-price-intel/src/components/projects/BudgetDashboard.tsx"
      to: "useProjectSelections"
      via: "Fetches all selections for aggregation"
      pattern: "useProjectSelections"
    - from: "material-price-intel/src/components/projects/VarianceChart.tsx"
      to: "recharts"
      via: "BarChart component"
      pattern: "BarChart|Bar "
    - from: "material-price-intel/src/pages/ProjectDetailPage.tsx"
      to: "BudgetDashboard"
      via: "Budget tab renders BudgetDashboard"
      pattern: "<BudgetDashboard"
---

<objective>
Build the budget vs actual variance dashboard showing financial health at every level of the project.

Purpose: The most critical question during construction is "am I on budget?" This dashboard answers that at project, room, and category levels -- showing exactly where money is being saved or overspent.

Output: BudgetDashboard component with variance table and chart, integrated into the Budget tab of ProjectDetailPage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-estimating-procurement/10-01-SUMMARY.md
@.planning/phases/10-estimating-procurement/10-03-SUMMARY.md
@.planning/phases/10-estimating-procurement/10-05-SUMMARY.md
@material-price-intel/src/lib/types.ts
@material-price-intel/src/hooks/useProjectSelections.ts
@material-price-intel/src/hooks/useProjectRooms.ts
@material-price-intel/src/components/reports/CategoryAggregateChart.tsx
@material-price-intel/src/pages/ProjectDetailPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VarianceChart component</name>
  <files>material-price-intel/src/components/projects/VarianceChart.tsx</files>
  <action>
Create a Recharts-based bar chart that visualizes budget variance.

Props:
```typescript
type VarianceChartProps = {
  data: Array<{
    name: string;          // Room or category name
    allowance: number;     // Budget allowance
    estimated: number;     // Estimated cost
    actual: number;        // Actual cost (0 if not yet bought out)
    variance: number;      // actual - allowance (or estimated - allowance if no actual)
  }>;
  groupBy: 'room' | 'category';
};
```

Render a grouped BarChart using Recharts (follow patterns from CategoryAggregateChart.tsx):
- X-axis: room/category name
- Y-axis: dollar amounts
- Three bar series:
  - Allowance (gray/slate bars)
  - Estimated (blue bars)
  - Actual (green if under allowance, red if over -- use a custom bar shape or conditional fill)
- Tooltip showing all three values formatted as USD
- Legend at bottom
- Responsive: use ResponsiveContainer width="100%" height={350}
- If actual is 0 for a group, don't render the actual bar (use custom bar logic to skip)

Also show a variance indicator on each bar group:
- Use a Recharts ReferenceLine or label to show the delta
- Alternatively, add a separate thin bar for variance (positive = red, negative = green)

Chart should be readable for 5-15 groups (rooms or categories). If more than 15, horizontal layout may be needed -- use a layout="vertical" prop on BarChart when data.length > 12.

Format dollars on Y-axis with abbreviated format: $1K, $5K, $10K, $45K, etc. Use a custom tick formatter:
```typescript
const formatDollarAxis = (value: number) => {
  if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`;
  return `$${value}`;
};
```
  </action>
  <verify>
1. `cd material-price-intel && npx tsc --noEmit` passes
2. Component renders without errors with sample data
3. Three bar series visible with correct colors
4. Tooltip shows formatted USD values
5. Responsive container adapts to parent width
  </verify>
  <done>VarianceChart renders a clear comparison of allowance vs estimated vs actual costs by room or category.</done>
</task>

<task type="auto">
  <name>Task 2: Create BudgetDashboard and integrate into ProjectDetailPage Budget tab</name>
  <files>
    material-price-intel/src/components/projects/BudgetDashboard.tsx
    material-price-intel/src/pages/ProjectDetailPage.tsx
  </files>
  <action>
**Create BudgetDashboard.tsx:**

Props: `{ projectId: string, targetBudget: number | null }`

This component aggregates all selection data and presents multi-level variance analysis.

**Data fetching and aggregation:**
- Uses useProjectSelections(projectId) for all selections
- Uses useProjectRooms(projectId) for room names
- Uses useQuery to fetch material_categories for category names

**Computed aggregations (all done client-side from selections data):**

1. **Project-level totals:**
   - total_allowance: SUM(allowance_amount) across all selections
   - total_estimated: SUM(estimated_total)
   - total_actual: SUM(actual_total) where actual exists
   - total_variance: total_actual - total_allowance (or total_estimated - total_allowance if no actuals)
   - budget_remaining: targetBudget - total_actual (or targetBudget - total_estimated)
   - items_with_actuals: count of selections where actual_total is not null
   - total_items: count of all selections

2. **Room-level aggregation:**
   - Group selections by room_id
   - For each room: sum allowance, estimated, actual, compute variance
   - Include room name from useProjectRooms

3. **Category-level aggregation:**
   - Group selections by category_id
   - For each category: sum allowance, estimated, actual, compute variance
   - Include category display_name

**Layout:**

1. **Summary cards row** (4 cards):
   - Total Budget: targetBudget (or "Not set")
   - Total Allowances: total_allowance
   - Current Estimate: total_estimated
   - Projected Variance: total_variance (green if under, red if over, with +/- prefix)

2. **Budget health indicator:**
   - Progress bar showing total_actual / targetBudget (or total_estimated / targetBudget if no actuals yet)
   - Color: green if <90%, amber if 90-100%, red if >100%
   - Text: "X% of budget used" or "X% over budget"

3. **Chart toggle**: "By Room" | "By Category" buttons
   - Renders VarianceChart with appropriate groupBy and data

4. **Detailed variance table:**
   - Sortable table with rows for each room (or category, matching chart toggle)
   - Columns: Name | Allowance | Estimated | Actual | Variance | Variance %
   - Expandable rows: clicking a room row shows the individual selections within
   - Variance column: dollar amount with color (green negative = under budget, red positive = over budget)
   - Variance %: ((actual or estimated) - allowance) / allowance * 100, formatted with +/- and %
   - Footer row: project totals (bold)
   - Sort by: name, variance amount, variance % (default: variance % descending to show biggest overages first)

5. **Unbudgeted items warning:**
   - If any selections have no allowance_amount, show a warning card:
   - "X selections have no allowance set. Set allowances to track budget variance."
   - List the selection names

**Update ProjectDetailPage.tsx:**
- Replace the "Budget" tab placeholder with BudgetDashboard component
- Pass projectId and project.target_budget as props
- Also update the summary cards at the top of the page to use the get_project_summary RPC when available:
  - Use supabase.rpc('get_project_summary', { p_project_id: projectId })
  - This gives server-computed totals as a cross-check

**Dollar formatting:**
- Consistent throughout: `new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value)` for totals
- Use 2 decimal places for per-unit prices
  </action>
  <verify>
1. `cd material-price-intel && npx tsc --noEmit` passes
2. Budget tab shows summary cards with correct totals
3. Chart renders by room and by category (toggle works)
4. Variance table shows per-room breakdown
5. Expanding a room row shows individual selections
6. Colors correctly indicate over/under budget
7. Budget health bar shows percentage
  </verify>
  <done>Budget dashboard provides multi-level variance analysis: project totals, room/category breakdown with chart, and detailed expandable table. Builders can instantly see where they're over or under budget.</done>
</task>

</tasks>

<verification>
1. Budget tab renders with project-level summary cards
2. VarianceChart shows grouped bars for allowance/estimated/actual
3. Toggle between room and category views works
4. Variance table is sortable and expandable
5. Colors correctly indicate budget health (green=under, red=over)
6. Budget health progress bar accurate
7. Unbudgeted items warning shown when appropriate
8. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Multi-level variance: project, room, and category level views
- Visual chart makes variance immediately scannable
- Detailed table allows drill-down to individual selections
- Budget health bar gives at-a-glance project financial status
- Green/red color coding consistently indicates under/over budget
- Handles edge cases: no actuals yet, no allowances set, no target budget
</success_criteria>

<output>
After completion, create `.planning/phases/10-estimating-procurement/10-06-SUMMARY.md`
</output>
