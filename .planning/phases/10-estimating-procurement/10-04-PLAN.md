---
phase: 10-estimating-procurement
plan: 04
type: execute
wave: 4
depends_on: ["10-03"]
files_modified:
  - material-price-intel/src/hooks/useEstimateBuilder.ts
  - material-price-intel/src/components/projects/EstimateBuilder.tsx
  - material-price-intel/src/pages/ProjectDetailPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can auto-populate estimated prices from historical quote data"
    - "Estimate shows the basis: average price, quote count, latest supplier"
    - "User can accept or override the suggested price"
    - "Estimated totals update when prices are populated"
    - "Only approved/verified quotes feed into estimates"
  artifacts:
    - path: "material-price-intel/src/hooks/useEstimateBuilder.ts"
      provides: "Hook to fetch price stats and auto-populate estimates"
      exports: ["useMaterialPriceStats", "useAutoEstimate"]
    - path: "material-price-intel/src/components/projects/EstimateBuilder.tsx"
      provides: "Estimate generation UI within project context"
      min_lines: 80
  key_links:
    - from: "material-price-intel/src/hooks/useEstimateBuilder.ts"
      to: "get_material_price_stats RPC"
      via: "supabase.rpc()"
      pattern: "rpc.*get_material_price_stats"
    - from: "material-price-intel/src/components/projects/EstimateBuilder.tsx"
      to: "useUpdateSelection"
      via: "Updates estimated_unit_price on selection"
      pattern: "useUpdateSelection"
---

<objective>
Build the estimate generation feature that pulls historical pricing from the existing price database to auto-populate project estimates.

Purpose: This is the key value bridge between the price intelligence system (phases 1-9) and estimating. A builder says "I need Red Oak hardwood for the kitchen" and the system responds "Based on 12 quotes, Red Oak averages $4.82/sqft. Latest price was $4.65/sqft from 84 Lumber on Jan 15."

Output: Price stats hook, EstimateBuilder component integrated into ProjectDetailPage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-estimating-procurement/10-01-SUMMARY.md
@.planning/phases/10-estimating-procurement/10-03-SUMMARY.md
@material-price-intel/src/lib/types.ts
@material-price-intel/src/hooks/useProjectSelections.ts
@material-price-intel/src/pages/ProjectDetailPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useEstimateBuilder hook</name>
  <files>material-price-intel/src/hooks/useEstimateBuilder.ts</files>
  <action>
Create a hooks file for estimate generation functionality.

1. `useMaterialPriceStats(materialId: string | undefined)` - Calls the get_material_price_stats RPC.
   - queryKey: ["material_price_stats", materialId]
   - enabled: !!materialId
   - staleTime: 5 * 60 * 1000
   - Call: `supabase.rpc('get_material_price_stats', { p_material_id: materialId })`
   - Returns the first row of the result (the RPC returns an array, but it's always 1 row)
   - Type the return as MaterialPriceStats | null

2. `useBulkPriceStats(materialIds: string[])` - Fetches price stats for multiple materials at once. Used when loading an entire project's selections.
   - queryKey: ["material_price_stats_bulk", ...materialIds.sort()]
   - enabled: materialIds.length > 0
   - staleTime: 5 * 60 * 1000
   - Implementation: Call get_material_price_stats RPC for each materialId in parallel using Promise.all
   - Returns: Record<string, MaterialPriceStats> (keyed by materialId)
   - Filter out null results

3. `useAutoEstimate()` - Mutation that auto-populates estimated_unit_price on a selection based on historical data.
   - Takes: { selectionId: string, roomId: string, materialId: string, quantity: number | null, priceStrategy: 'average' | 'latest' | 'lowest' }
   - Steps:
     a. Fetch price stats via supabase.rpc('get_material_price_stats', { p_material_id: materialId })
     b. Determine estimated_unit_price based on priceStrategy:
        - 'average': use avg_price
        - 'latest': use latest_price
        - 'lowest': use min_price
     c. Calculate estimated_total = quantity * estimated_unit_price (or just estimated_unit_price if quantity is null)
     d. Update the selection via supabase.from('project_selections').update({ estimated_unit_price, estimated_total }).eq('id', selectionId)
   - On success: invalidate ["project_selections", roomId] and ["project_selections_all"]
   - On error: throw with descriptive message ("No pricing data available for this material")
  </action>
  <verify>
1. `cd material-price-intel && npx tsc --noEmit` passes
2. All 3 hooks exported
3. RPC call matches the function signature in types.ts
  </verify>
  <done>Estimate hooks compile and correctly call the get_material_price_stats RPC.</done>
</task>

<task type="auto">
  <name>Task 2: Create EstimateBuilder component and integrate into ProjectDetailPage</name>
  <files>
    material-price-intel/src/components/projects/EstimateBuilder.tsx
    material-price-intel/src/pages/ProjectDetailPage.tsx
  </files>
  <action>
**Create EstimateBuilder.tsx** - A component that shows price intelligence for a selection and lets the user populate estimates.

Props: `{ selection: ProjectSelection & { materials?: Material | null }, roomId: string }`

This component renders inside the SelectionEditor when a selection has a material_id assigned. It shows:

1. **Price Intelligence Card** (rendered as a small Card within the selection row or as an expandable panel):
   - Uses useMaterialPriceStats(selection.material_id)
   - Shows (if data available):
     - "Average Price: $X.XX/unit (based on N quotes)"
     - "Lowest: $X.XX | Highest: $X.XX"
     - "Latest: $X.XX from [supplier] on [date]"
   - If no data: "No historical pricing data available for this material"

2. **Estimate Actions** (only shown when price data exists):
   - Three buttons in a button group:
     - "Use Average ($X.XX)" -- calls useAutoEstimate with strategy 'average'
     - "Use Latest ($X.XX)" -- calls useAutoEstimate with strategy 'latest'
     - "Use Lowest ($X.XX)" -- calls useAutoEstimate with strategy 'lowest'
   - Each button disabled if that price value is null
   - Clicking any button:
     - Sets estimated_unit_price on the selection
     - Calculates estimated_total = quantity * estimated_unit_price
     - Shows a brief success state (button text changes to checkmark for 2 seconds)

3. **Current Estimate Display** (always shown if estimated_unit_price exists):
   - "Estimated: $X.XX/unit x [quantity] [unit] = $X,XXX.XX total"
   - If allowance_amount exists: "vs allowance of $X,XXX.XX" with variance indicator

**Integrate into SelectionEditor.tsx:**
- When a selection has material_id, render EstimateBuilder below the selection row (or as an expandable detail)
- Add a "Get Estimate" toggle/button on each selection row that has a material_id. Clicking it expands the EstimateBuilder for that selection.
- Use local state to track which selection is expanded (expandedSelectionId)

**Update ProjectDetailPage.tsx:**
- Add a "Auto-Estimate All" button in the project header area. This button:
  - Finds all selections with material_id but no estimated_unit_price
  - Calls useAutoEstimate for each one with strategy 'average'
  - Shows progress: "Estimating 3 of 12 items..."
  - Disabled when no selections need estimates
  - After completion: summary toast or inline message "12 items estimated"
- The project status should change from 'planning' to 'estimating' when the first estimate is generated (call useUpdateProject to set status)
  </action>
  <verify>
1. `cd material-price-intel && npx tsc --noEmit` passes
2. Selection with material_id shows "Get Estimate" button
3. Expanding shows price intelligence from historical data
4. Clicking "Use Average" populates estimated_unit_price and estimated_total
5. "Auto-Estimate All" processes all selections with materials
6. Summary cards update with new estimated totals
  </verify>
  <done>Estimate builder shows historical pricing and populates estimates. Builders can see "based on 12 quotes, Red Oak averages $4.82/sqft" and populate with one click.</done>
</task>

</tasks>

<verification>
1. Single selection estimate: select material -> get estimate -> see price data -> click "Use Average" -> estimated price populated
2. Bulk estimate: "Auto-Estimate All" populates all selections that have materials
3. Price sources are from verified/approved quotes only (enforced by RPC)
4. Estimated totals = quantity * unit price
5. Summary cards reflect updated estimates
6. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Historical price data displayed inline on selections that have materials assigned
- Three pricing strategies available: average, latest, lowest
- Bulk "Auto-Estimate All" for efficiency on large projects
- Clear attribution: "based on N quotes" with latest supplier info
- Estimated totals calculated from quantity * price
- Project status transitions from 'planning' to 'estimating'
</success_criteria>

<output>
After completion, create `.planning/phases/10-estimating-procurement/10-04-SUMMARY.md`
</output>
