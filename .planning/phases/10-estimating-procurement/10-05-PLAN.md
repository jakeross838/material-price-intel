---
phase: 10-estimating-procurement
plan: 05
type: execute
wave: 5
depends_on: ["10-04"]
files_modified:
  - material-price-intel/src/hooks/useProcurement.ts
  - material-price-intel/src/components/projects/ProcurementTracker.tsx
  - material-price-intel/src/components/projects/QuoteLinkModal.tsx
  - material-price-intel/src/pages/ProjectDetailPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can link an existing supplier quote to a project selection (buyout)"
    - "User can update procurement status: not_quoted -> rfq_sent -> quoted -> awarded -> ordered -> delivered -> installed"
    - "Awarded quote price becomes the selection's actual price"
    - "User can see procurement progress across the whole project"
    - "Procurement creates the bridge between price intelligence and purchasing"
  artifacts:
    - path: "material-price-intel/src/hooks/useProcurement.ts"
      provides: "React Query hooks for procurement CRUD"
      exports: ["useProcurementItems", "useCreateProcurement", "useUpdateProcurement", "useAwardQuote"]
    - path: "material-price-intel/src/components/projects/ProcurementTracker.tsx"
      provides: "Procurement status board for project selections"
      min_lines: 100
    - path: "material-price-intel/src/components/projects/QuoteLinkModal.tsx"
      provides: "Modal to search and link existing quotes to selections"
      min_lines: 80
  key_links:
    - from: "material-price-intel/src/hooks/useProcurement.ts"
      to: "supabase.from('procurement_items')"
      via: "Supabase client"
      pattern: "from.*procurement_items"
    - from: "QuoteLinkModal"
      to: "quotes + line_items tables"
      via: "Search existing quotes by supplier/material"
      pattern: "from.*quotes|from.*line_items"
    - from: "useAwardQuote"
      to: "project_selections.actual_unit_price"
      via: "Updates selection with committed price"
      pattern: "actual_unit_price|actual_total"
---

<objective>
Build procurement/buyout tracking that links existing supplier quotes to project selections, turning estimates into actual purchase commitments.

Purpose: After estimating, the builder sends out for quotes (already handled by the existing system). When quotes come back, the builder needs to "buy out" each selection by awarding a quote to it. This bridges the price intelligence system with actual purchasing decisions.

Output: Procurement hooks, tracker component, quote linking modal, integrated into project detail.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-estimating-procurement/10-01-SUMMARY.md
@.planning/phases/10-estimating-procurement/10-03-SUMMARY.md
@.planning/phases/10-estimating-procurement/10-04-SUMMARY.md
@material-price-intel/src/lib/types.ts
@material-price-intel/src/hooks/useProjectSelections.ts
@material-price-intel/src/pages/ProjectDetailPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create procurement hooks</name>
  <files>material-price-intel/src/hooks/useProcurement.ts</files>
  <action>
Create React Query hooks for procurement management.

1. `useProcurementItems(projectId: string | undefined)` - Fetches all procurement items for a project.
   - queryKey: ["procurement_items", projectId]
   - enabled: !!projectId
   - staleTime: 5 * 60 * 1000
   - Implementation: First get all selection IDs for the project (via project_rooms -> project_selections), then query procurement_items WHERE selection_id IN those IDs.
   - Select: `*, project_selections(id, selection_name, room_id, material_id, quantity, unit, estimated_unit_price, estimated_total, actual_unit_price, actual_total, allowance_amount), quotes(id, supplier_id, quote_number, quote_date, suppliers(name)), line_items(id, raw_description, unit_price, effective_unit_price, quantity, unit)`
   - Order by status (custom order: not_quoted first, installed last), then by selection name

2. `useSelectionProcurement(selectionId: string | undefined)` - Fetches the procurement item for a single selection.
   - queryKey: ["procurement_item", selectionId]
   - enabled: !!selectionId
   - staleTime: 5 * 60 * 1000
   - Single row fetch since procurement_items has UNIQUE(selection_id)
   - Same joins as above

3. `useCreateProcurement()` - Creates a procurement record for a selection.
   - Takes: { selection_id: string, projectId: string }
   - Creates with status 'not_quoted'
   - On success: invalidate ["procurement_items", projectId] and ["procurement_item", selection_id]

4. `useUpdateProcurement()` - Updates procurement status and fields.
   - Takes: { id: string, projectId: string, selectionId: string, updates: Partial<ProcurementItem> }
   - On success: invalidate ["procurement_items", projectId] and ["procurement_item", selectionId]

5. `useAwardQuote()` - Awards a quote line item to a selection (the key buyout action).
   - Takes: { procurementId: string, selectionId: string, roomId: string, projectId: string, quoteId: string, lineItemId: string, committedPrice: number, unitPrice: number }
   - Steps:
     a. Update procurement_items: set quote_id, line_item_id, committed_price, status='awarded'
     b. Update project_selections: set actual_unit_price=unitPrice, actual_total=committed_price, supplier_id=(from quote's supplier_id)
     c. Auto-calculate upgrade_status based on actual_total vs allowance_amount
   - On success: invalidate procurement and selection caches

6. `useSearchQuotesForSelection(materialId: string | undefined, categoryId: string | undefined)` - Search existing quotes that match a selection's material.
   - queryKey: ["quotes_for_selection", materialId, categoryId]
   - enabled: !!(materialId || categoryId)
   - staleTime: 5 * 60 * 1000
   - Query line_items WHERE material_id = materialId (if provided) AND line_type = 'material'
   - Join quotes and suppliers
   - Select: line_item id, raw_description, unit_price, effective_unit_price, quantity, unit, quote(id, quote_number, quote_date, supplier(id, name))
   - Order by quote_date desc
   - Limit 20
  </action>
  <verify>
1. `cd material-price-intel && npx tsc --noEmit` passes
2. All 6 hooks exported
3. useAwardQuote updates both procurement_items and project_selections
4. Cache invalidation covers all affected queries
  </verify>
  <done>Procurement hooks compile and handle the full buyout workflow: create procurement record, search matching quotes, award quote, update status.</done>
</task>

<task type="auto">
  <name>Task 2: Create ProcurementTracker, QuoteLinkModal, and integrate into ProjectDetailPage</name>
  <files>
    material-price-intel/src/components/projects/ProcurementTracker.tsx
    material-price-intel/src/components/projects/QuoteLinkModal.tsx
    material-price-intel/src/pages/ProjectDetailPage.tsx
  </files>
  <action>
**Create QuoteLinkModal.tsx** - Modal for linking a quote to a selection:

Props: `{ selection: ProjectSelection, procurementId: string, projectId: string, onClose: () => void, onAwarded: () => void }`

- Shows as a dialog/modal overlay (use a div with fixed positioning + backdrop, or create a simple Dialog component)
- Header: "Link Quote to: [selection_name]"
- Uses useSearchQuotesForSelection(selection.material_id, selection.category_id) to find matching quotes
- Displays results in a table:
  - Supplier name
  - Quote number
  - Quote date
  - Unit price (effective_unit_price, with fallback to unit_price)
  - Description (raw_description)
  - "Award" button
- If no matching quotes found: "No matching quotes found. Upload a quote first, then link it here."
- Clicking "Award":
  - Calculates committed_price: effectiveUnitPrice * selection.quantity (or effectiveUnitPrice if no quantity)
  - Calls useAwardQuote mutation
  - On success: calls onAwarded(), closes modal
- Close button / click-outside-to-close / Escape key to dismiss

**Create ProcurementTracker.tsx** - Project-level procurement status view:

Props: `{ projectId: string }`

- Uses useProcurementItems(projectId)
- Uses useProjectSelections(projectId) to find selections without procurement records

- **Progress summary bar** at top:
  - Total selections count
  - Breakdown by procurement status (colored segments):
    - not_quoted (gray)
    - rfq_sent (blue)
    - quoted (amber)
    - awarded (purple)
    - ordered (indigo)
    - delivered (teal)
    - installed (green)
  - Percentage complete: (awarded + ordered + delivered + installed) / total * 100
  - "X of Y items bought out"

- **Procurement table** below:
  - Columns: Selection Name | Material | Status | Supplier | Price | Actions
  - Status shown as colored badge (same colors as above)
  - Status is a dropdown select that user can change (calls useUpdateProcurement)
  - Supplier name from linked quote (or "--" if not linked)
  - Price: committed_price if awarded, estimated_unit_price if not yet
  - Actions column:
    - "Link Quote" button (opens QuoteLinkModal) -- shown when status is 'not_quoted', 'rfq_sent', or 'quoted'
    - "View Quote" link (navigates to /quotes/:id) -- shown when quote is linked
    - Status advance buttons: If status is 'awarded', show "Mark Ordered" button. If 'ordered', show "Mark Delivered". If 'delivered', show "Mark Installed".
  - Selections without procurement records get a "Start Tracking" button that creates a procurement_item

- **Filtering/grouping:**
  - Group by status (collapsible sections) OR flat table with status column
  - Choose flat table (simpler, more scannable for 200+ items)
  - Add a status filter dropdown at the top to show only specific statuses

**Update ProjectDetailPage.tsx:**

- Add a tab-like navigation below the summary cards: "Rooms & Selections" | "Procurement" | "Budget"
  - Use simple button-based tabs (no routing, just local state)
  - "Rooms & Selections" shows the existing RoomManager + SelectionEditor (from Plan 03)
  - "Procurement" shows ProcurementTracker
  - "Budget" shows a placeholder "Budget dashboard coming in Plan 06"
- Default tab: "Rooms & Selections"
- When project status is 'in_progress', default to "Procurement" tab
- Update project status to 'in_progress' when first procurement item is awarded

**Styling notes:**
- Status badge colors should be consistent across the app
- Use Button variant="outline" for secondary actions, variant="default" for primary
- Modal backdrop: fixed inset-0 bg-black/50 z-50, modal content: bg-white rounded-lg shadow-xl max-w-2xl mx-auto mt-20
  </action>
  <verify>
1. `cd material-price-intel && npx tsc --noEmit` passes
2. ProcurementTracker shows all selections with their buyout status
3. "Link Quote" opens modal with matching quotes from the database
4. Awarding a quote updates both procurement status and selection actual price
5. Status can be advanced through the workflow
6. Tab navigation works between Rooms, Procurement, and Budget views
7. Progress bar shows accurate buyout completion percentage
  </verify>
  <done>Full procurement workflow functional: track status, search quotes, award to selections, advance through ordering/delivery/install.</done>
</task>

</tasks>

<verification>
1. End-to-end buyout: Create selection -> material assigned -> open procurement -> link quote -> award -> mark ordered -> delivered -> installed
2. Quote search returns relevant matches based on material_id
3. Awarding updates actual_unit_price, actual_total, and supplier_id on the selection
4. Upgrade status auto-recalculates after award
5. Progress bar reflects correct percentages
6. Tab navigation works on ProjectDetailPage
7. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Procurement status workflow covers full lifecycle: not_quoted through installed
- Quote linking modal finds and displays relevant existing quotes
- Awarding a quote bridges procurement to actual pricing
- Progress visualization shows project buyout completion
- Tab navigation organizes the growing project detail page
- Status transitions update project status appropriately
</success_criteria>

<output>
After completion, create `.planning/phases/10-estimating-procurement/10-05-SUMMARY.md`
</output>
