---
phase: 10-estimating-procurement
plan: 03
type: execute
wave: 3
depends_on: ["10-02"]
files_modified:
  - material-price-intel/src/hooks/useProjectRooms.ts
  - material-price-intel/src/hooks/useProjectSelections.ts
  - material-price-intel/src/components/projects/RoomManager.tsx
  - material-price-intel/src/components/projects/SelectionEditor.tsx
  - material-price-intel/src/pages/ProjectDetailPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can add rooms/areas to a project (Master Bath, Kitchen, etc.)"
    - "User can remove rooms from a project"
    - "User can add material selections to a room with allowance and quantity"
    - "User can edit and remove selections"
    - "Selections show upgrade/downgrade status relative to allowance"
  artifacts:
    - path: "material-price-intel/src/hooks/useProjectRooms.ts"
      provides: "React Query hooks for room CRUD"
      exports: ["useProjectRooms", "useCreateRoom", "useDeleteRoom"]
    - path: "material-price-intel/src/hooks/useProjectSelections.ts"
      provides: "React Query hooks for selection CRUD"
      exports: ["useRoomSelections", "useCreateSelection", "useUpdateSelection", "useDeleteSelection"]
    - path: "material-price-intel/src/components/projects/RoomManager.tsx"
      provides: "Room list with add/remove functionality"
      min_lines: 60
    - path: "material-price-intel/src/components/projects/SelectionEditor.tsx"
      provides: "Selection list with inline editing"
      min_lines: 100
  key_links:
    - from: "material-price-intel/src/pages/ProjectDetailPage.tsx"
      to: "RoomManager, SelectionEditor"
      via: "Component composition"
      pattern: "<RoomManager|<SelectionEditor"
    - from: "material-price-intel/src/hooks/useProjectRooms.ts"
      to: "supabase.from('project_rooms')"
      via: "Supabase client"
      pattern: "from.*project_rooms"
    - from: "material-price-intel/src/hooks/useProjectSelections.ts"
      to: "supabase.from('project_selections')"
      via: "Supabase client"
      pattern: "from.*project_selections"
---

<objective>
Build room management and selection editing within the project detail page.

Purpose: The core of estimating is defining what materials go where in the home. A builder needs to say "Kitchen needs flooring, countertops, cabinets" and "Master Bath needs tile, fixtures, countertops" -- then assign allowance budgets and quantities to each.

Output: Room and selection hooks, RoomManager and SelectionEditor components, integrated into ProjectDetailPage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-estimating-procurement/10-01-SUMMARY.md
@.planning/phases/10-estimating-procurement/10-02-SUMMARY.md
@material-price-intel/src/lib/types.ts
@material-price-intel/src/hooks/useProjects.ts
@material-price-intel/src/pages/ProjectDetailPage.tsx
@material-price-intel/src/hooks/useMaterials.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create room and selection hooks</name>
  <files>
    material-price-intel/src/hooks/useProjectRooms.ts
    material-price-intel/src/hooks/useProjectSelections.ts
  </files>
  <action>
**Create useProjectRooms.ts** (follow useMaterials.ts pattern):

1. `useProjectRooms(projectId: string | undefined)` - Fetches all rooms for a project, ordered by sort_order then name.
   - queryKey: ["project_rooms", projectId]
   - enabled: !!projectId
   - staleTime: 5 * 60 * 1000

2. `useCreateRoom()` - Mutation to create a room.
   - Takes: { project_id: string, name: string, room_type?: RoomType, notes?: string }
   - On success: invalidate ["project_rooms", project_id]

3. `useUpdateRoom()` - Mutation to update a room.
   - Takes: { id: string, project_id: string, updates: { name?: string, room_type?: RoomType, sort_order?: number, notes?: string } }
   - On success: invalidate ["project_rooms", project_id]

4. `useDeleteRoom()` - Mutation to delete a room (CASCADE deletes its selections).
   - Takes: { id: string, project_id: string }
   - On success: invalidate ["project_rooms", project_id]

**Create useProjectSelections.ts:**

1. `useRoomSelections(roomId: string | undefined)` - Fetches selections for a room with joined material and category data.
   - queryKey: ["project_selections", roomId]
   - enabled: !!roomId
   - staleTime: 5 * 60 * 1000
   - Select: `*, materials(id, canonical_name, species, dimensions, unit_of_measure), material_categories(id, name, display_name), suppliers(id, name)`
   - Order by sort_order

2. `useProjectSelections(projectId: string | undefined)` - Fetches ALL selections across all rooms for a project. Used for project-level summaries.
   - queryKey: ["project_selections_all", projectId]
   - enabled: !!projectId
   - First fetch rooms for the project, then fetch selections for all room IDs using .in('room_id', roomIds)
   - If no rooms, return empty array
   - Include same joins as useRoomSelections

3. `useCreateSelection()` - Mutation to create a selection.
   - Takes: { room_id: string, selection_name: string, category_id?: string, material_id?: string, description?: string, allowance_amount?: number, quantity?: number, unit?: string, estimated_unit_price?: number, estimated_total?: number, supplier_id?: string, notes?: string }
   - On success: invalidate ["project_selections", room_id] and ["project_selections_all"]

4. `useUpdateSelection()` - Mutation to update a selection.
   - Takes: { id: string, room_id: string, updates: Partial<ProjectSelection> }
   - Must NOT include variance_amount in the update (it's a generated column)
   - On success: invalidate ["project_selections", room_id] and ["project_selections_all"]

5. `useDeleteSelection()` - Mutation to delete a selection.
   - Takes: { id: string, room_id: string }
   - On success: invalidate ["project_selections", room_id] and ["project_selections_all"]
  </action>
  <verify>
1. `cd material-price-intel && npx tsc --noEmit` passes
2. All hooks exported
3. Query keys are consistent (cache invalidation will work)
4. Joined selects match the Supabase relationship definitions from types.ts
  </verify>
  <done>All room and selection hooks compile and export correctly with proper cache invalidation.</done>
</task>

<task type="auto">
  <name>Task 2: Create RoomManager, SelectionEditor, and integrate into ProjectDetailPage</name>
  <files>
    material-price-intel/src/components/projects/RoomManager.tsx
    material-price-intel/src/components/projects/SelectionEditor.tsx
    material-price-intel/src/pages/ProjectDetailPage.tsx
  </files>
  <action>
**Create RoomManager.tsx** - A component that manages rooms within a project:

Props: `{ projectId: string }`

- Uses useProjectRooms(projectId)
- Displays a list of room cards. Each card shows:
  - Room name (bold)
  - Room type badge (interior/exterior/utility/common)
  - Delete button (Trash2 icon, with confirmation via window.confirm)
- "Add Room" form at the bottom:
  - Text input for room name
  - Select dropdown for room_type (interior, exterior, utility, common)
  - "Add" button
  - Use inline form (useState for name and type, clear after successful add)
- Common room presets button: A dropdown or button group that lets the user quickly add standard rooms. When clicked, show a list of checkboxes:
  - Kitchen, Master Bath, Master Bedroom, Guest Bath 1, Guest Bath 2, Guest Bedroom 1, Guest Bedroom 2, Great Room, Dining Room, Laundry, Garage, Exterior, Pool/Lanai
  - "Add Selected" button creates all checked rooms at once
  - Each preset has a default room_type (Kitchen=interior, Exterior=exterior, Garage=utility, etc.)
- Clicking a room name selects it (tracked via local state: selectedRoomId)
- Selected room shows SelectionEditor below/beside it

**Create SelectionEditor.tsx** - Manages selections within a room:

Props: `{ roomId: string, projectId: string }`

- Uses useRoomSelections(roomId)
- Uses useMaterials() to provide material selection dropdown
- Uses useQuery to fetch material_categories for category dropdown

- Displays a table/list of selections. Each row shows:
  - selection_name (editable inline or via click-to-edit)
  - Category name (from joined data)
  - Material name (from joined data, or "Not selected" if null)
  - Allowance ($X,XXX formatted)
  - Quantity + unit (e.g., "800 sqft")
  - Estimated total ($X,XXX) -- computed as quantity * estimated_unit_price if both exist
  - Actual total ($X,XXX or "--" if not yet bought out)
  - Variance (actual - allowance, colored: green if negative/under budget, red if positive/over budget, gray if pending)
  - Upgrade status badge: standard (gray), upgrade (amber), downgrade (green), pending (blue)
  - Delete button (X icon)

- "Add Selection" form below the table:
  - selection_name (text, required)
  - category_id (select dropdown from material_categories query)
  - material_id (select dropdown from useMaterials, filtered by category_id if selected)
  - allowance_amount (number input, formatted as dollars)
  - quantity (number input)
  - unit (select: sqft, lf, ea, pc, bf)
  - "Add" button

- Clicking a selection row opens an edit mode (inline editing or a modal -- prefer inline for simplicity):
  - All fields become editable
  - Save / Cancel buttons appear
  - Use useUpdateSelection mutation

- Upgrade status auto-calculation: When actual_total and allowance_amount both exist:
  - If actual_total > allowance_amount * 1.01: 'upgrade'
  - If actual_total < allowance_amount * 0.99: 'downgrade'
  - Otherwise: 'standard'
  - Set upgrade_status on update

**Update ProjectDetailPage.tsx** - Replace placeholder rooms section:

- Import and render RoomManager component, passing projectId
- The page now shows a two-panel layout below the summary cards:
  - Left panel (w-1/3): RoomManager (room list + add room)
  - Right panel (w-2/3): SelectionEditor for the selected room (or empty state "Select a room to view selections")
- Use useState for selectedRoomId, default to first room from useProjectRooms
- Summary cards should now use useProjectSelections(projectId) to show real totals:
  - Total Allowance: sum of all selection allowance_amounts
  - Total Estimated: sum of all selection estimated_totals
  - Total Actual: sum of all selection actual_totals (only where actual exists)
  - Variance: total actual - total allowance

**Styling notes:**
- Use existing Card, CardContent, Button, Input, Label components
- Table: use plain HTML table with Tailwind (following SearchPage.tsx patterns)
- Dollar formatting: `new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value)`
- Variance colors: text-green-600 for under budget, text-red-600 for over budget
  </action>
  <verify>
1. `cd material-price-intel && npx tsc --noEmit` passes
2. ProjectDetailPage renders RoomManager on left and SelectionEditor on right
3. Can add rooms via form and via presets
4. Can add selections to a room
5. Can edit selection fields inline
6. Can delete rooms and selections
7. Summary cards update when selections change
8. Variance shows correct color coding
  </verify>
  <done>Room management and selection editing fully functional. Users can define the complete material scope of a custom home project with rooms, selections, allowances, and quantities.</done>
</task>

</tasks>

<verification>
1. Full room lifecycle: add (manual + presets) -> select -> view selections -> delete
2. Full selection lifecycle: add -> edit inline -> delete
3. Selections show joined material/category/supplier names
4. Summary cards show real aggregated totals
5. Variance calculation and color coding works
6. Data persists across page refreshes
7. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Rooms can be added manually and via presets (standard home rooms)
- Selections within rooms support all fields: name, category, material, allowance, quantity, unit
- Inline editing of selections works
- Summary cards show project-level aggregated financial data
- Upgrade/downgrade status auto-calculated from allowance vs actual
- All data persists in Supabase via RLS-scoped queries
</success_criteria>

<output>
After completion, create `.planning/phases/10-estimating-procurement/10-03-SUMMARY.md`
</output>
